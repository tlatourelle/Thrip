<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
  <head>
    <title>Spark Documentation</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <base href="http://sparkviewengine.com" />
    <link type="text/css" rel="stylesheet" href="misc/print.css" />
      </head>
  <body>
        
    <div id="node-4" class="section-1">
  <h1 class="book-heading">Spark Documentation</h1>
  <h3 id="WhatisSpark">What is Spark</h3>

<p>Spark is a view engine for Asp.Net Mvc and Castle Project MonoRail frameworks. The idea is to allow the html to dominate the flow and the code to fit seamlessly.</p>

<p>For example,</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;ul<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;li</span> <span class="re0">each</span>=<span class="st0">'var p in ViewData.Model.Products'</span><span class="re2">&gt;</span></span>
    ${p.Name} !{Html.ActionLink[[ProductController]](c=&gt;c.Edit(p.Id), &quot;Edit&quot;)}
  <span class="sc3"><span class="re1">&lt;/li<span class="re2">&gt;</span></span></span>  
<span class="sc3"><span class="re1">&lt;/ul<span class="re2">&gt;</span></span></span></pre></div></p>

<p>The full csharp language is available in a way that doesn't interfere with the harmony and balance of the markup. The view template files produced compiled classes.</p>

<h3 id="Needsdocumentation">Needs documentation</h3>

<ul>
<li>Web-Application relative <code>~/</code> urls</li>
<li>Support for <code>&lt;def&gt;</code> and <code>&lt;var&gt;</code></li>
<li>Capture content directly to variables</li>
<li>Inner text on partial views</li>
<li>monorail view components</li>
<li>clientside rendering</li>
<li>javascript clientside views</li>
<li>Use of ${expr} and !{expr} and automaticEncoding</li>
<li>late bound ${#prop} and ${Eval("prop")}</li>
<li>view areas</li>
</ul>
  <div id="node-10" class="section-2">
  <h1 class="book-heading">Configuring Spark</h1>
  <div class="toc">
<div class="toc-title">Table of Contents [<a href="#" class="toc-toggle">hide</a>]</div>
<div class="toc-list">
<ul>

<ul>

<ul>
	<li><a href="#AddingtoCastleMonoRail">Adding to Castle MonoRail</a></li>
	<li><a href="#AddingtoAspNetMVC">Adding to Asp.Net MVC</a></li>
	<li><a href="#Sparksettingsinconfigfile">Spark settings in config file</a></li>
	<li><a href="#Sparksettingsincode">Spark settings in code</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<h3 id="AddingtoCastleMonoRail">Adding to Castle MonoRail</h3>

<p>In the web application add references to the <strong>Castle.MonoRail.Views.Spark</strong> and <strong>Spark</strong> assemblies.</p>

<p>In the &lt;monorail&gt; section configure the spark view engine.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;monorail<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;viewEngines</span> <span class="re0">viewPathRoot</span>=<span class="st0">&quot;Views&quot;</span><span class="re2">&gt;</span></span>
    <span class="sc3"><span class="re1">&lt;add</span> <span class="re0">type</span>=<span class="st0">&quot;Castle.MonoRail.Views.Spark.SparkViewFactory, Castle.MonoRail.Views.Spark&quot;</span><span class="re2">/&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;/viewEngines<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/monorail<span class="re2">&gt;</span></span></span></pre></div></p>

<p>That's about it really.</p>

<h3 id="AddingtoAspNetMVC">Adding to Asp.Net MVC</h3>

<p><em>View engines are no managed by the controller. This section is now correct for Preview 5</em></p>

<p>The simplest way to use Spark from an Asp.Net MVC web application is to register an instance of the SparkViewFactory inn your Global Application_Start function at the same point you would be registering routes and such.</p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw1">protected</span> <span class="kw1">void</span> Application_Start<span class="br0">&#40;</span><span class="kw4">object</span> sender, EventArgs e<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    ViewEngines.<span class="me1">Engines</span>.<span class="me1">Add</span><span class="br0">&#40;</span><span class="kw3">new</span> SparkViewFactory<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></div></p>

<p>This is also an excellent place to provide any other non-default services to the view factory. Such as an IViewFolder that reads from embedded resources instead of the file system, or an IViewActivatorFactory which can take over the responsibility of instantiating the compiled view types.</p>

<p><em>todo - document use of IoC for this</em></p>

<h3 id="Sparksettingsinconfigfile">Spark settings in config file</h3>

<p>After the Spark view engine is integrated into your MVC, MonoRail, or other application there are some additional settings you may want to configure. One way to do this is with a &lt;spark&gt; config file section.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;configSections<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;section</span> <span class="re0">name</span>=<span class="st0">&quot;spark&quot;</span> <span class="re0">type</span>=<span class="st0">&quot;Spark.Configuration.SparkSectionHandler, Spark&quot;</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;/configSections<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;spark<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;compilation</span> <span class="re0">debug</span>=<span class="st0">&quot;true|false&quot;</span> <span class="re0">defaultLanguage</span>=<span class="st0">&quot;Default|CSharp|VisualBasic&quot;</span><span class="re2">&gt;</span></span>
    <span class="sc3"><span class="re1">&lt;assemblies<span class="re2">&gt;</span></span></span>
      <span class="sc3"><span class="re1">&lt;add</span> <span class="re0">assembly</span>=<span class="st0">&quot;YourAssemblyName&quot;</span> <span class="re2">/&gt;</span></span>
      <span class="sc3"><span class="re1">&lt;add</span> <span class="re0">assembly</span>=<span class="st0">&quot;YourOtherStrongAssemblyName, Version=3.5.0.0, Culture=neutral, PublicKeyToken=31BF3856AD364E35&quot;</span> <span class="re2">/&gt;</span></span>
    <span class="sc3"><span class="re1">&lt;/assemblies<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;/compilation<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;pages</span> <span class="re0">automaticEncoding</span>=<span class="st0">&quot;true|false&quot;</span> <span class="re0">pageBaseType</span>=<span class="st0">&quot;Your.NonDefault.BaseSparkView&quot;</span> <span class="re0">prefix</span>=<span class="st0">&quot;{optional string}&quot;</span><span class="re2">&gt;</span></span>
    <span class="sc3"><span class="re1">&lt;namespaces<span class="re2">&gt;</span></span></span>
      <span class="sc3"><span class="re1">&lt;add</span> <span class="re0">namespace</span>=<span class="st0">&quot;System&quot;</span><span class="re2">/&gt;</span></span>
      <span class="sc3"><span class="re1">&lt;add</span> <span class="re0">namespace</span>=<span class="st0">&quot;System.Collections.Generic&quot;</span><span class="re2">/&gt;</span></span>
      <span class="sc3"><span class="re1">&lt;add</span> <span class="re0">namespace</span>=<span class="st0">&quot;System.Linq&quot;</span><span class="re2">/&gt;</span></span>
      <span class="sc3"><span class="re1">&lt;add</span> <span class="re0">namespace</span>=<span class="st0">&quot;System.Web.Mvc&quot;</span><span class="re2">/&gt;</span></span>
    <span class="sc3"><span class="re1">&lt;/namespaces<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;resources<span class="re2">&gt;</span></span></span>
      <span class="sc3"><span class="re1">&lt;add</span> <span class="re0">match</span>=<span class="st0">&quot;/content/css&quot;</span> <span class="re0">location</span>=<span class="st0">&quot;http://www.yourcdnprovider.com/youraccount/allstyles/css&quot;</span><span class="re2">/&gt;</span></span>
      <span class="sc3"><span class="re1">&lt;add</span> <span class="re0">match</span>=<span class="st0">&quot;/content/js&quot;</span> <span class="re0">location</span>=<span class="st0">&quot;http://www.yourcdnprovider.com/youraccount/appname/js&quot;</span><span class="re2">/&gt;</span></span>
    <span class="sc3"><span class="re1">&lt;/resources<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;/pages<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/spark<span class="re2">&gt;</span></span></span></pre></div></p>

<p>The defaultLanguage may be specified if you are using a language like VisualBasic. It's not necessary for nearly any other case.</p>

<p>Additional assemblies and namespaces can be referenced with &lt;use assembly="..." namespace="..." /&gt; in view, layout, and partial files. All assemblies loaded in the app domain are automatically referenced, there may be times you want to add references explicitly for assemblies that aren't yet loaded.</p>

<p>The default page base type, MvcContrib.SparkViewEngine.SparkView or Castle.MonoRail.Views.Spark.SparkView, will be used if one isn't specified. If you do provide a class as the page base type you'll probably inherit from the default base class.</p>

<p>Automatic HTML encoding of output may be enabled. This will result in every instance of ${expr} output passing through the intrinsic HTML encoding method H(). The syntax !{expr} is used in this case for output which should be sent unencoded.</p>

<p>An optional prefix may be selected, which must then be used on all Spark elements and attributes in your template files. The prefix should not be set here if you're defining a prefix in the templates with xmlns attributes.</p>

<p>The resources section may be used to control the result of ~/ style urls. For example, <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;script</span> <span class="re0">src</span>=<span class="st0">&quot;~/content/js/foo.js&quot;</span><span class="re2">/&gt;</span></span></code></span> will normally appear as a ${SiteRoot} prefixed url but the match for "/content/js" above will make that url appear as the given location + "/foo.js". The assumption for high-volume sites is you would use the normal urls for development and map them to a static file server or to a cdn provider in production.</p>

<h3 id="Sparksettingsincode">Spark settings in code</h3>

<p>Another way to provide these settings to the spark engine is to provide an ISparkSettings instance to the constructor.</p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw1">protected</span> <span class="kw1">void</span> Application_Start<span class="br0">&#40;</span><span class="kw4">object</span> sender, EventArgs e<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    <span class="kw4">var</span> settings <span class="sy0">=</span> <span class="kw3">new</span> SparkSettings<span class="br0">&#40;</span><span class="br0">&#41;</span>
        .<span class="me1">SetDebug</span><span class="br0">&#40;</span><span class="kw1">true</span><span class="br0">&#41;</span>
        .<span class="me1">SetPageBaseType</span><span class="br0">&#40;</span><span class="st0">&quot;Your.NonDefault.BaseSparkView&quot;</span><span class="br0">&#41;</span>
        .<span class="me1">AddAssembly</span><span class="br0">&#40;</span><span class="st0">&quot;YourAssembly&quot;</span><span class="br0">&#41;</span>
        .<span class="me1">AddNamespace</span><span class="br0">&#40;</span><span class="st0">&quot;System&quot;</span><span class="br0">&#41;</span>
        .<span class="me1">AddNamespace</span><span class="br0">&#40;</span><span class="st0">&quot;System.Collections.Generic&quot;</span><span class="br0">&#41;</span>
        .<span class="me1">AddNamespace</span><span class="br0">&#40;</span><span class="st0">&quot;System.Linq&quot;</span><span class="br0">&#41;</span>
        .<span class="me1">AddNamespace</span><span class="br0">&#40;</span><span class="st0">&quot;System.Web.Mvc&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    ViewEngines.<span class="me1">Engines</span>.<span class="me1">Add</span><span class="br0">&#40;</span><span class="kw3">new</span> SparkViewFactory<span class="br0">&#40;</span>settings<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></div></p>
  </div>
<div id="node-9" class="section-2">
  <h1 class="book-heading">General Syntax</h1>
  <p><div class="toc">
<div class="toc-title">Table of Contents [<a href="#" class="toc-toggle">hide</a>]</div>
<div class="toc-list">
<ul>

<ul>

<ul>
	<li><a href="#Basicmarkup">Basic markup</a></li>
	<li><a href="#Includingcode">Including code</a></li>
	<li><a href="#Specialcharactersincode">Special characters in code</a></li>
	<li><a href="#Sparkelementprefixwithconfig">Spark element prefix with config</a></li>
	<li><a href="#Sparkelementprefixwithxmlnsnamespaces">Spark element prefix with xmlns namespaces</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div></p>

<h3 id="Basicmarkup">Basic markup</h3>

<p>A view file has basic html markup that can appear pretty much as you'd expect.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;div<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>Hello <span class="sc3"><span class="re1">&lt;span<span class="re2">&gt;</span></span></span>world<span class="sc3"><span class="re1">&lt;/span<span class="re2">&gt;</span></span></span>!<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span></pre></div></p>

<h3 id="Includingcode">Including code</h3>

<p>CSharp code may be used to produce output. Any helper methods, object properties, or expression that evaluates to a non-void value can be used.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>${&quot;Hello world&quot;}<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>${Guid.NewGuid().ToString(&quot;n&quot;)}<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span></pre></div></p>

<p>Code will also appear in special attributes or elements like "if", "else", and "var". These types of areas will never require ${} or <%= %> notation.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;var</span> <span class="re0">names</span>=<span class="st0">&quot;new [] {'alpha', 'beta', 'gamma'}&quot;</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;for</span> <span class="re0">each</span>=<span class="st0">&quot;var name in names&quot;</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;test</span> <span class="re0">if</span>=<span class="st0">&quot;name == 'beta'&quot;</span><span class="re2">&gt;</span></span>
    <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>beta is my favorite.<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;else</span><span class="re2">/&gt;</span></span>
    <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>${name} is okay too I suppose. 
  <span class="sc3"><span class="re1">&lt;/test<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/for<span class="re2">&gt;</span></span></span></pre></div></p>

<p>However if you use code to produce a normal attribute's value, that is not a special attribute does require the code-output notation.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;viewdata</span> <span class="re0">currentProduct</span>=<span class="st0">&quot;Product&quot;</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>${currentProduct.Name} <span class="sc3"><span class="re1">&lt;a</span> <span class="re0">href</span>=<span class="st0">&quot;/Product/Edit/${currentProduct.Id}&quot;</span><span class="re2">&gt;</span></span>Edit<span class="sc3"><span class="re1">&lt;/a<span class="re2">&gt;</span></span></span><span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span></pre></div></p>

<h3 id="Specialcharactersincode">Special characters in code</h3>

<p>The entire functionality of the csharp language is available. As always, please use responsibly. :) Be sure to put business logic in your controller's actions and write unit test for it.</p>

<p>There are a small number of characters that are parsed in a special way to avoid simple mechanical problems you can encounter in a standard xml editor.</p>

<p>The sequences [[ and ]] are parsed as if they are < and >. This can be convenient when you're using generic classes or methods from a spark file, to avoid the editor's tendency to add a closing elements for you. The [[ and ]] will not be changed if they occur inside a string literal.</p>

<p>String literals may be expressed in 'single quotes' in addition to "double quotes". This is again for convenience when using expressions inside attributes values that are contained in double quotes. If you do need to use a single char constant in an expression, using an explicit type-cast (char)'x' will avoid having the string changed to "x".</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;viewdata</span> <span class="re0">products</span>=<span class="st0">&quot;IList[[Products]]&quot;</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;var</span> <span class="re0">styles</span>=<span class="st0">&quot;new[] {'even', 'odd'}&quot;</span><span class="re2">/&gt;</span></span></pre></div></p>

<h3 id="Sparkelementprefixwithconfig">Spark element prefix with config</h3>

<p>By default, Spark tags are unqualified. All of the examples you'll see are written that way. That can cause a problem if Spark is being used to create xml rather than xhtml. One of the ways to disambiguate spark xml from output xml is to set a prefix for your application.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;spark<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;pages</span> <span class="re0">prefix</span>=<span class="st0">&quot;s&quot;</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;/spark<span class="re2">&gt;</span></span></span></pre></div></p>

<p>Or<br />
<div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw4">var</span> settings <span class="sy0">=</span> <span class="kw3">new</span> SparkSettings<span class="br0">&#40;</span><span class="br0">&#41;</span>
    .<span class="me1">SetPrefix</span><span class="br0">&#40;</span><span class="st0">&quot;s&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre></div></p>

<p>At which point all of the native spark elements and attributes must include the s: prefix to be recognized. None of the built-in prefixes macro:, content:, use:, render:, and section: are affected by the use of the prefix setting.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;div<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;s:viewdata</span> <span class="re0">user</span>=<span class="st0">&quot;UserInfo&quot;</span><span class="re2">/&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;p</span> <span class="re0">s:if</span>=<span class="st0">&quot;user != null&quot;</span><span class="re2">&gt;</span></span>${user.Name}<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;s:LoginForm</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span></pre></div></p>

<h3 id="Sparkelementprefixwithxmlnsnamespaces">Spark element prefix with xmlns namespaces</h3>

<p>Another way to disambiguate the markup is to declare xmlns attributes, which will result in well-formed and valid xml. All of the Spark namespace Uris begin with <a href="http://sparkviewengine.com/" title="http://sparkviewengine.com/">http://sparkviewengine.com/</a>. If a template file contains a Spark xmlns attribute then the other built-in prefixes (macro:, etc.) will only function if their namespace Uri's are also declared. </p>

<table>
<tr>
<th>Default prefix</th>
<th>Namespace Uri</th>
</tr>
<tr>
<th>none - spark tags and partial files</th>
<th>http://sparkviewengine/</th>
</tr>
<tr>
<th>content:</th>
<th>http://sparkviewengine/content/</th>
</tr>
<tr>
<th>use:</th>
<th>http://sparkviewengine/use/</th>
</tr>
<tr>
<th>macro:</th>
<th>http://sparkviewengine/macro/</th>
</tr>
<tr>
<th>section:</th>
<th>http://sparkviewengine/section/</th>
</tr>
<tr>
<th>render:</th>
<th>http://sparkviewengine/render/</th>
</tr>
</table>

<p>You can use the defaults or specify any prefix you choose. Once an xmlns attribute is defined only the value on the namespace Uri is significant.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;html</span> <span class="re0">xmlns</span>=<span class="st0">&quot;http://www.w3.org/1999/xhtml&quot;</span>
      <span class="re0">xmlns:s</span>=<span class="st0">&quot;http://sparkviewengine.com/&quot;</span>
      <span class="re0">xmlns:fn</span>=<span class="st0">&quot;http://sparkviewengine.com/macro/&quot;</span><span class="re2">&gt;</span></span>
<span class="sc3"><span class="re1">&lt;body<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;fn:ShowNames</span> <span class="re0">favorite</span>=<span class="st0">&quot;string&quot;</span><span class="re2">&gt;</span></span>
    <span class="sc3"><span class="re1">&lt;s:var</span> <span class="re0">names</span>=<span class="st0">&quot;new [] {'alpha', 'beta', 'gamma'}&quot;</span><span class="re2">/&gt;</span></span>
    <span class="sc3"><span class="re1">&lt;s:for</span> <span class="re0">each</span>=<span class="st0">&quot;var name in names&quot;</span><span class="re2">&gt;</span></span>
      <span class="sc3"><span class="re1">&lt;s:test</span> <span class="re0">if</span>=<span class="st0">&quot;name == favorite&quot;</span><span class="re2">&gt;</span></span>
        <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>${favorite} is my favorite.<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
        <span class="sc3"><span class="re1">&lt;s:else</span><span class="re2">/&gt;</span></span>
        <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>${name} is okay too I suppose.
      <span class="sc3"><span class="re1">&lt;/s:test<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;/s:for<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;/fn:ShowNames<span class="re2">&gt;</span></span></span>
  ${ShowNames(&quot;beta&quot;)}
  ${ShowNames(&quot;gamma&quot;)}
<span class="sc3"><span class="re1">&lt;/body<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/html<span class="re2">&gt;</span></span></span></pre></div></p>
  </div>
<div id="node-6" class="section-2">
  <h1 class="book-heading">Variables</h1>
  <p><div class="toc">
<div class="toc-title">Table of Contents [<a href="#" class="toc-toggle">hide</a>]</div>
<div class="toc-list">
<ul>

<ul>

<ul>
	<li><a href="#Declaringlocalvariables">Declaring local variables</a></li>
	<li><a href="#Declaringglobalvariables">Declaring global variables</a></li>
	<li><a href="#Settinglocalandglobalvalues">Setting local and global values</a></li>
	<li><a href="#Usingviewdata">Using view data</a></li>
	<li><a href="#Usingviewdatawithatypedmodel">Using view data with a typed model</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div></p>

<h3 id="Declaringlocalvariables">Declaring local variables</h3>

<p>The var element is a quick and easy way to declare local variables. The default behavior is to create a local of automatic type "var" which is initialized inline.</p>

<p>For example, the following:</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;var</span> <span class="re0">styles</span>=<span class="st0">&quot;new [] {'odd', 'even'}&quot;</span> <span class="re0">i</span>=<span class="st0">&quot;0&quot;</span><span class="re2">/&gt;</span></span></pre></div></p>

<p>Produces the following:</p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw4">var</span> styles <span class="sy0">=</span> <span class="kw3">new</span> <span class="br0">&#91;</span><span class="br0">&#93;</span> <span class="br0">&#123;</span><span class="st0">&quot;odd&quot;</span>, <span class="st0">&quot;even&quot;</span><span class="br0">&#125;</span><span class="sy0">;</span>
<span class="kw4">var</span> i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span></pre></div></p>

<p>The var element has an optional type attribute which can be used to provide an explicit type used instead of the automatic type syntax "var".</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;var</span> <span class="re0">foo</span>=<span class="st0">&quot;null&quot;</span> <span class="re0">bar</span>=<span class="st0">&quot;null&quot;</span> <span class="re0">type</span>=<span class="st0">&quot;string&quot;</span><span class="re2">/&gt;</span></span></pre></div></p>

<p>Will declare variables of type <span class="geshifilter"><code class="geshifilter-xml">string</code></span> instead of <span class="geshifilter"><code class="geshifilter-xml">var</code></span>.</p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw4">string</span> foo <span class="sy0">=</span> null<span class="sy0">;</span>
<span class="kw4">string</span> bar <span class="sy0">=</span> null<span class="sy0">;</span></pre></div></p>

<p>Finally if the var element is not declared as a self-closing tag the scope of the variables will be limited. For example:</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;div<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;var</span> <span class="re0">styles</span>=<span class="st0">&quot;new [] {'even', 'odd'}&quot;</span> <span class="re0">i</span>=<span class="st0">&quot;0&quot;</span><span class="re2">&gt;</span></span>
    <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>${i} is ${styles[i%2]}<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;/var<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;set</span> <span class="re0">i</span>=<span class="st0">&quot;5&quot;</span><span class="re2">/&gt;</span></span> <span class="sc3"><span class="coMULTI">&lt;!-- compiler error - variable i is out of scope --&gt;</span></span>
<span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span></pre></div></p>

<p>will result in:</p>

<p><div class="geshifilter"><pre class="geshifilter-csharp">Output.<span class="me1">Write</span><span class="br0">&#40;</span><span class="st0">&quot;&lt;div&gt;&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#123;</span>
<span class="kw4">var</span> styles<span class="sy0">=</span><span class="kw3">new</span><span class="br0">&#91;</span><span class="br0">&#93;</span> <span class="br0">&#123;</span><span class="st0">&quot;even&quot;</span>, <span class="st0">&quot;odd&quot;</span><span class="br0">&#125;</span><span class="sy0">;</span>
<span class="kw4">var</span> i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>
Output.<span class="me1">Write</span><span class="br0">&#40;</span><span class="st0">&quot;&lt;p&gt;&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
Output.<span class="me1">Write</span><span class="br0">&#40;</span>i<span class="br0">&#41;</span><span class="sy0">;</span>
Output.<span class="me1">Write</span><span class="br0">&#40;</span><span class="st0">&quot; is &quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
Output.<span class="me1">Write</span><span class="br0">&#40;</span>styles<span class="br0">&#91;</span>i<span class="sy0">%</span><span class="nu0">2</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span>
Output.<span class="me1">Write</span><span class="br0">&#40;</span><span class="st0">&quot;&lt;/p&gt;&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
Output.<span class="me1">Write</span><span class="br0">&#40;</span><span class="st0">&quot;&lt;/div&gt;&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
i <span class="sy0">=</span> <span class="nu0">5</span><span class="sy0">;</span></pre></div></p>

<p>In this case the local variables are only available inside the <var></var> element. This can be convenient to scope explicitly.</p>

<h3 id="Declaringglobalvariables">Declaring global variables</h3>

<p>Local variables have a limited scope. They're declared in the generated class right in line in the methods that are generating output. Globals on the other hand can be declared at any location in the view, master, or partial template files and the value can be used and assigned at any point.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;h2<span class="re2">&gt;</span></span></span>${Title}<span class="sc3"><span class="re1">&lt;/h2<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;global</span> <span class="re0">Title</span>=<span class="st0">&quot;'My Default Title'&quot;</span><span class="re2">/&gt;</span></span></pre></div></p>

<p>Global variables are actually implemented as field members of the view class. So the above example would contain <span class="geshifilter"><code class="geshifilter-csharp"><span class="kw4">object</span> Title<span class="sy0">=</span><span class="st0">&quot;My Default Title&quot;</span><span class="sy0">;</span></code></span> which is available to from any method. You may also use provide a type attribute to avoid using the default field type object. Multiple variables may be defined in the same element.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;global</span> <span class="re0">type</span>=<span class="st0">&quot;string&quot;</span> <span class="re0">Foo</span>=<span class="st0">&quot;'Hello'&quot;</span> <span class="re0">Bar</span>=<span class="st0">&quot;'World'&quot;</span> <span class="re2">/&gt;</span></span></pre></div></p>

<h3 id="Settinglocalandglobalvalues">Setting local and global values</h3>

<p>The ${expression} and <%=expression%> syntax is only useful for producing a value to send to output. For local and global variable assignment the set element may be used.</p>

<p>Using global for title</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;html<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;head<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;global</span> <span class="re0">type</span>=<span class="st0">'string'</span> <span class="re0">Title</span>=<span class="st0">'&quot;Site Name&quot;'</span><span class="re2">/&gt;</span></span>
    <span class="sc3"><span class="re1">&lt;title<span class="re2">&gt;</span></span></span>${Title}<span class="sc3"><span class="re1">&lt;/title<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;/head<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;body<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;div<span class="re2">&gt;</span></span></span><span class="sc3"><span class="re1">&lt;use</span> <span class="re0">content</span>=<span class="st0">&quot;view&quot;</span><span class="re2">/&gt;</span></span><span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;/body<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/html<span class="re2">&gt;</span></span></span></pre></div></p>

<p>View that sets the title</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;set</span> <span class="re0">Title</span>=<span class="st0">'product.Name + &quot; - &quot; + Title'</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="coMULTI">&lt;!-- or --&gt;</span></span>
<span class="sc3"><span class="re1">&lt;set</span> <span class="re0">Title</span>=<span class="st0">'string.Format(&quot;{0} - {1}&quot;, product.Name, Title)'</span><span class="re2">/&gt;</span></span></pre></div></p>

<h3 id="Usingviewdata">Using view data</h3>

<p>A ViewData property is available as an object dictionary on the base class so syntax like ${ViewData["blah"]} is valid. There is an easier option however which adds a strongly typed property accessor for a view data member.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;viewdata</span> 
  <span class="re0">Caption</span>=<span class="st0">&quot;string&quot;</span> 
  <span class="re0">Products</span>=<span class="st0">&quot;System.Collections.Generic.IList[[MyApp.Models.Product]]&quot;</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;div<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;h3<span class="re2">&gt;</span></span></span>${Caption}<span class="sc3"><span class="re1">&lt;/h3<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;div</span>  <span class="re0">each</span>=<span class="st0">&quot;var product in Products&quot;</span><span class="re2">&gt;</span></span>
    <span class="sc3"><span class="re1">&lt;h4<span class="re2">&gt;</span></span></span>${product.Name}<span class="sc3"><span class="re1">&lt;/h4<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;div<span class="re2">&gt;</span></span></span>${product.Description}<span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span></pre></div></p>

<p>The viewdata element may occur anywhere in the view or master file actually. The net result is the same which is to add something like the following to the generated class.</p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw4">string</span> Caption 
<span class="br0">&#123;</span>get <span class="br0">&#123;</span><span class="kw1">return</span> <span class="br0">&#40;</span><span class="kw4">string</span><span class="br0">&#41;</span>ViewData<span class="br0">&#91;</span><span class="st0">&quot;Caption&quot;</span><span class="br0">&#93;</span><span class="sy0">;</span><span class="br0">&#125;</span><span class="br0">&#125;</span>
&nbsp;
<span class="kw5">System</span>.<span class="me1">Collections</span>.<span class="me1">Generic</span>.<span class="me1">IList</span><span class="sy0">&lt;</span>MyApp.<span class="me1">Models</span>.<span class="me1">Product</span><span class="sy0">&gt;</span> Products 
<span class="br0">&#123;</span>get <span class="br0">&#123;</span><span class="kw1">return</span> <span class="br0">&#40;</span><span class="kw5">System</span>.<span class="me1">Collections</span>.<span class="me1">Generic</span>.<span class="me1">IList</span><span class="sy0">&lt;</span>MyApp.<span class="me1">Models</span>.<span class="me1">Product</span><span class="sy0">&gt;</span><span class="br0">&#41;</span>ViewData<span class="br0">&#91;</span><span class="st0">&quot;Products&quot;</span><span class="br0">&#93;</span><span class="sy0">;</span><span class="br0">&#125;</span><span class="br0">&#125;</span></pre></div></p>

<p>In this case the [[ and ]] are replaced with < and > because of the difficulty xml-centric editors have with certain characters appearing in attributes.</p>

<h3 id="Usingviewdatawithatypedmodel">Using view data with a typed model</h3>

<p>The viewdata element may have a model attribute in the view or master file.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;viewdata</span> <span class="re0">model</span>=<span class="st0">&quot;MyApp.Models.Catalog&quot;</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>(${ViewData.Model.CatalogID}) ${ViewData.Model.Name} <span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span></pre></div></p>

<p>The net effect is to have the model attribute used as the TModel parameter for the ViewDataDictionary.</p>

<p>The model attribute can be used in conjunction with the other viewdata variable declaration. For example if your master template uses a typecast named viewdata argument to access a member variable, like <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;viewdata</span> <span class="re0">Title</span>=<span class="st0">&quot;string&quot;</span><span class="re2">/&gt;</span></span></code></span>, your views can still use a specific <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;viewdata</span> <span class="re0">model</span>=<span class="st0">&quot;typename&quot;</span><span class="re2">/&gt;</span></span></code></span> if the type has a string Title property.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;viewdata</span> <span class="re0">Title</span>=<span class="st0">&quot;string&quot;</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;title<span class="re2">&gt;</span></span></span>${Html.Encode(Title ?? &quot;My Sample MVC Application&quot;)}<span class="sc3"><span class="re1">&lt;/title<span class="re2">&gt;</span></span></span></pre></div></p>

<p>The above example enables you to add a string Title property to any class used as a TModel, or as an automatic class <span class="geshifilter"><code class="geshifilter-csharp"><span class="kw3">new</span> <span class="br0">&#123;</span>Title <span class="sy0">=</span> <span class="st0">&quot;hello&quot;</span><span class="br0">&#125;</span></code></span>, or as a dictionary entry in an untyped view data dictionary. </p>
  </div>
<div id="node-5" class="section-2">
  <h1 class="book-heading">Expressions</h1>
  <div class="toc">
<div class="toc-title">Table of Contents [<a href="#" class="toc-toggle">hide</a>]</div>
<div class="toc-list">
<ul>

<ul>

<ul>
	<li><a href="#Simplecsharpexpressions">Simple csharp expressions</a></li>
	<li><a href="#Nullsinexpressions">Nulls in expressions</a></li>
	<li><a href="#UsingMvcHelpers">Using Mvc Helpers</a></li>
	<li><a href="#Conditionalelementsiftestandelse">Conditional elements if, test, and else</a></li>
	<li><a href="#Conditionalattributesifandelseif">Conditional attributes if and elseif</a></li>
	<li><a href="#Conditionalattributeonce">Conditional attribute once</a></li>
	<li><a href="#Conditionalattributeoutput">Conditional attribute output</a></li>
	<li><a href="#Loopinganditeration">Looping and iteration</a></li>
	<li><a href="#Iterationwiththeeachattribute">Iteration with the each attribute</a></li>
	<li><a href="#Usingnamespace">Using namespace</a></li>
	<li><a href="#Inlinecode">Inline code</a></li>
	<li><a href="#DeclaringMacros">Declaring Macros</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<h3 id="Simplecsharpexpressions">Simple csharp expressions</h3>

<p>Any csharp syntax can appear as ${expression} or <%=expression%></p>

<p>The expression text itself is reproduced verbatim as a <span class="geshifilter"><code class="geshifilter-csharp">TextWriter.<span class="me1">Write</span><span class="br0">&#40;</span>expression<span class="br0">&#41;</span><span class="sy0">;</span></code></span> line. So anything that evaluates to a string, simple type, or object with ToString can be used in an expression.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;div<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>The time is ${DateTime.Now}.<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>The time is <span class="sc3"><span class="re1">&lt;</span>%=DateTime.Now%<span class="re2">&gt;</span></span>.<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span></pre></div></p>

<h3 id="Nullsinexpressions">Nulls in expressions</h3>

<p>By default when a NullReferenceException is thrown from the <code>${expressions}</code> or <code>&lt;%=expression%&gt;</code> it will be caught and the original expression will be output. This is similar to the behavior you will find in NVelocity and is intended to assist troubleshooting simple data problems.</p>

<p>The syntax <code>$!{expression}</code> can also be used if you want to ensure any null values and NullReferenceException that result from the expression will produce no output at all.</p>

<p>For example, with the following template:
<div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;div</span> <span class="re0">class</span>=<span class="st0">&quot;shipto&quot;</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>$!{currentInvoice.ShipTo.FullName}<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>$!{currentInvoice.ShipTo.Address.City}, $!{currentInvoice.ShipTo.Address.State} $!{currentInvoice.ShipTo.Address.Zip}<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span></pre></div></p>

<p>If there is a null <code>currentInvoice</code> or a null <code>ShipTo</code>, the output would be:
<div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;div</span> <span class="re0">class</span>=<span class="st0">&quot;shipto&quot;</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span><span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>,  <span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span></pre></div></p>

<p>It's not ideal by a long shot, but slightly better than a yellow screen of death if you don't manage to get a hundred percent correct null testing in your views.</p>

<h3 id="UsingMvcHelpers">Using Mvc Helpers</h3>

<p>There are instances of HtmlHelper, UrlHelper, and AjaxHelper available as Html, Url, and Ajax properties respectively. Any of their methods which return string-friendly information can be used as an output expressions.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="coMULTI">&lt;!-- Link to the Sort action on the current controller --&gt;</span></span>
<span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>${Html.ActionLink(&quot;Click me&quot;, &quot;Sort&quot;)}<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="coMULTI">&lt;!-- Put out data in a way that's safe --&gt;</span></span>
<span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>${Html.Encode(stuff)}<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span></pre></div></p>

<h3 id="Conditionalelementsiftestandelse">Conditional elements if, test, and else</h3>

<p>The elements &lt;if&gt; and &lt;else&gt; can be used to produce content conditionally. The if element must have a condition attribute which is used literally as the boolean csharp expression.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;var</span> <span class="re0">x</span>=<span class="st0">'5'</span><span class="re2">/&gt;</span></span>
&nbsp;
<span class="sc3"><span class="re1">&lt;if</span> <span class="re0">condition</span>=<span class="st0">'x == 5'</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;p</span> <span class="re0">class</span>=<span class="st0">'resultmessage'</span><span class="re2">&gt;</span></span>Some value is five<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/if<span class="re2">&gt;</span></span></span></pre></div></p>

<p>An &lt;if&gt; element may be followed by any number of optional &lt;else&gt; elements that have if attributes and finally a single, optional &lt;else&gt; element. Only whitespace may be between the if/else elements.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;viewdata</span> <span class="re0">user</span>=<span class="st0">'UserInfo'</span><span class="re2">/&gt;</span></span>
&nbsp;
<span class="sc3"><span class="re1">&lt;if</span> <span class="re0">condition</span>=<span class="st0">'!user.IsLoggedIn()'</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>Here's a login form<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/if<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;else</span> <span class="re0">if</span>=<span class="st0">'user.HasRole(RoleType.Administrator)'</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>Hello - you're an admin<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/else<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;else</span> <span class="re0">if</span>=<span class="st0">'user.HasRole(RoleType.Registered)'</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>Hello - you're a registered user<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/else<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;else<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>I have no idea what type of person you are<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/else<span class="re2">&gt;</span></span></span></pre></div></p>

<p>If you prefer, instread of &lt;if condition=""&gt; you can use the &lt;test if=""&gt; syntax. The functionality is the same. Another variation on the syntax is the ability to use empty &lt;else if=""/&gt; and &lt;else/&gt; elements inside of the <if> or <test>. The following identical to the example above.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;viewdata</span> <span class="re0">user</span>=<span class="st0">'UserInfo'</span><span class="re2">/&gt;</span></span>
&nbsp;
<span class="sc3"><span class="re1">&lt;test</span> <span class="re0">if</span>=<span class="st0">'!user.IsLoggedIn()'</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>Here's a login form<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;else</span> <span class="re0">if</span>=<span class="st0">'user.HasRole(RoleType.Administrator)'</span><span class="re2">/&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>Hello - you're an admin<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;else</span> <span class="re0">if</span>=<span class="st0">'user.HasRole(RoleType.Registered)'</span><span class="re2">/&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>Hello - you're a registered user<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;else</span><span class="re2">/&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>I have no idea what type of person you are<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/test<span class="re2">&gt;</span></span></span></pre></div></p>

<h3 id="Conditionalattributesifandelseif">Conditional attributes if and elseif</h3>

<p>The if and elseif attributes can be used on any other element. This has the same effect as having a wrapping if or else element.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;var</span> <span class="re0">x</span>=<span class="st0">'5'</span><span class="re2">/&gt;</span></span>
&nbsp;
<span class="sc3"><span class="re1">&lt;p</span> <span class="re0">if</span>=<span class="st0">'x==5'</span> <span class="re0">class</span>=<span class="st0">'resultmessage'</span><span class="re2">&gt;</span></span>Some value is five<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span></pre></div></p>

<p>The same rules about order and whitespace apply. An element with an elseif="" attribute, or an else element, may only follow another conditional element.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;use</span> <span class="re0">namespace</span>=<span class="st0">'SampleApp.Models'</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;viewdata</span> <span class="re0">user</span>=<span class="st0">'UserInfo'</span><span class="re2">/&gt;</span></span>
&nbsp;
<span class="sc3"><span class="re1">&lt;p</span> <span class="re0">if</span>=<span class="st0">'!user.IsLoggedIn()'</span><span class="re2">&gt;</span></span>Here's a login form<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;p</span> <span class="re0">elseif</span>=<span class="st0">'user.HasRole(RoleType.Administrator)'</span><span class="re2">&gt;</span></span>Hello - you're an admin<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;p</span> <span class="re0">elseif</span>=<span class="st0">'user.HasRole(RoleType.Registered)'</span><span class="re2">&gt;</span></span>Hello - you're a registered user<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;else<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>I have no idea what type of person you are<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/else<span class="re2">&gt;</span></span></span></pre></div></p>

<h3 id="Conditionalattributeonce">Conditional attribute once</h3>

<p>A fairly typical situation can come up where a partial will need to add a stylesheet reference or some jquery code. On the one hand you don't want to have those resources pulled in multiple times if the partial is used more than once, and on the other hand you don't want to simply include that resource just once in the site layout for all pages whether they need it or not. One way to implement the middle ground is to declare a boolean flag and set it once when you add a script to the header.</p>

<p>To make this code smaller the attribute <span class="geshifilter"><code class="geshifilter-xml">once=&quot;flagname&quot;</code></span> was added. The contents of the element will be rendered only the first time any given "flagname" values is used when rendering a page. Any conventions can be used about what values are used as flags, the following is just an example. You may also use ${expr} or <%=expr%> syntax in the value of the once attribute.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;content</span> <span class="re0">name</span>=<span class="st0">&quot;head&quot;</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="coMULTI">&lt;!--  add jquery if it hasn't been yet, and add countdown plugin --&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;script</span> <span class="re0">once</span>=<span class="st0">&quot;jquery&quot;</span> <span class="re0">type</span>=<span class="st0">&quot;text/javascript&quot;</span> <span class="re0">src</span>=<span class="st0">&quot;~/content/js/jquery-1.2.6.js&quot;</span><span class="re2">/&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;script</span> <span class="re0">once</span>=<span class="st0">&quot;jquery-countdown&quot;</span> <span class="re0">type</span>=<span class="st0">&quot;text/javascript&quot;</span> <span class="re0">src</span>=<span class="st0">&quot;~/content/js/jquery.countdown.js&quot;</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;/content<span class="re2">&gt;</span></span></span></pre></div></p>

<p>The implementation if this attribute results in the <span class="geshifilter"><code class="geshifilter-xml">bool Once(string flagname)</code></span> method being called which returns true the first time a distinct value is used for the argument. This method may also be called from code.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;macro</span> <span class="re0">name</span>=<span class="st0">&quot;Peculiar&quot;</span> <span class="re0">issue</span>=<span class="st0">&quot;string&quot;</span><span class="re2">&gt;</span></span>
#if (Once(&quot;log-peculiar&quot;)) 
#  Logger.Warn(&quot;Something's not right on this page. First issue: &quot; + issue);
<span class="sc3"><span class="re1">&lt;/macro<span class="re2">&gt;</span></span></span></pre></div></p>

<h3 id="Conditionalattributeoutput">Conditional attribute output</h3>

<p>The syntax <code>?{boolean}</code> can be used only inside the text of an attribute. Text and code before the condition (up to and including the previous whitespace) will be controlled by the result of the boolean expression. In the generated code the boolean will appear directly inside the parenthesis of an if statement, so anything that evaluates to a bool is okay.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;ul<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;li</span> <span class="re0">each</span>=<span class="st0">&quot;var product in Products&quot;</span> <span class="re0">class</span>=<span class="st0">&quot;first?{productIsFirst} last?{productIsLast}&quot;</span><span class="re2">&gt;</span></span>
    ${H(product.Name)}
  <span class="sc3"><span class="re1">&lt;/li<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/ul<span class="re2">&gt;</span></span></span></pre></div></p>

<p>will output</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;ul<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;li</span> <span class="re0">class</span>=<span class="st0">&quot;first&quot;</span><span class="re2">&gt;</span></span>Alpha<span class="sc3"><span class="re1">&lt;/li<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;li<span class="re2">&gt;</span></span></span>Beta<span class="sc3"><span class="re1">&lt;/li<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;li<span class="re2">&gt;</span></span></span>Gamma<span class="sc3"><span class="re1">&lt;/li<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;li</span> <span class="re0">class</span>=<span class="st0">&quot; last&quot;</span><span class="re2">&gt;</span></span>Delta<span class="sc3"><span class="re1">&lt;/li<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/ul<span class="re2">&gt;</span></span></span>
or
<span class="sc3"><span class="re1">&lt;ul<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;li</span> <span class="re0">class</span>=<span class="st0">&quot;first last&quot;</span><span class="re2">&gt;</span></span>just one product<span class="sc3"><span class="re1">&lt;/li<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/ul<span class="re2">&gt;</span></span></span></pre></div></p>

<p>Plus if all of the text of an attribute is killed, or if the only thing in the attribute was the test, then the entire attribute will disappear from the output. That's for checkboxes and such.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;input</span> <span class="re0">type</span>=<span class="st0">&quot;checkbox&quot;</span> <span class="re0">name</span>=<span class="st0">&quot;chkhello&quot;</span> <span class="re0">checked</span>=<span class="st0">&quot;?{isHelloChecked}&quot;</span><span class="re2">&gt;</span></span><span class="sc3"><span class="re1">&lt;/input<span class="re2">&gt;</span></span></span></pre></div></p>

<p>will output</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;input</span> <span class="re0">type</span>=<span class="st0">&quot;checkbox&quot;</span> <span class="re0">name</span>=<span class="st0">&quot;chkhello&quot;</span> <span class="re0">checked</span>=<span class="st0">&quot;&quot;</span><span class="re2">&gt;</span></span><span class="sc3"><span class="re1">&lt;/input<span class="re2">&gt;</span></span></span>
or
<span class="sc3"><span class="re1">&lt;input</span> <span class="re0">type</span>=<span class="st0">&quot;checkbox&quot;</span> <span class="re0">name</span>=<span class="st0">&quot;chkhello&quot;</span><span class="re2">&gt;</span></span><span class="sc3"><span class="re1">&lt;/input<span class="re2">&gt;</span></span></span></pre></div></p>

<h3 id="Loopinganditeration">Looping and iteration</h3>

<p>A foreach loop is produced with the element for and the attribute each. The each attribute is used verbatim so must have the type, variable name, "in", and collection.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;viewdata</span> <span class="re0">Posts</span>=<span class="st0">&quot;IList[[MyApp.Models.Post]&quot;</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;for</span> <span class="re0">each</span>=<span class="st0">&quot;var post in Posts&quot;</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>${post.Title}<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/for<span class="re2">&gt;</span></span></span></pre></div></p>

<p>Any for loop comes with several optional local variables. Their name is always the same as the looping variable, plus the suffixes "Index", "Count", "IsFirst", and "IsLast". The variables are scoped to the for loop itself, and only the ones which appear to be used in the contained code will be created.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;viewdata</span> <span class="re0">Posts</span>=<span class="st0">&quot;IList[[MyApp.Models.Post]&quot;</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;var</span> <span class="re0">styles</span>=<span class="st0">&quot;new[] {'even','odd'}&quot;</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;for</span> <span class="re0">each</span>=<span class="st0">&quot;var post in Posts&quot;</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;p</span> <span class="re0">class</span>=<span class="st0">&quot;${styles[postIndex%2]}&quot;</span><span class="re2">&gt;</span></span>${postIndex}. ${post.Title}<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/for<span class="re2">&gt;</span></span></span></pre></div></p>

<p>Something to be aware with the use of the "Count" and "IsLast" variables - they both need to know how many items are in the collection before the iteration begins. For collections that resolve to IEnumerable&lt;T&gt; the Linq extension method .Count() is used, and for plain old IEnumerable Spark will run iterate the collection incrementing an integer to get the count. Not a performance problem of course, just worth mentioning.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;for</span> <span class="re0">each</span>=<span class="st0">&quot;var lineItem in CurrentInvoice.LineItems&quot;</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;tr<span class="re2">&gt;</span></span></span><span class="sc3"><span class="re1">&lt;td<span class="re2">&gt;</span></span></span>Item ${lineItemIndex} of ${lineItemCount}<span class="sc3"><span class="re1">&lt;/td<span class="re2">&gt;</span></span></span><span class="sc3"><span class="re1">&lt;td<span class="re2">&gt;</span></span></span>${lineItem.Etc}<span class="sc3"><span class="re1">&lt;/td<span class="re2">&gt;</span></span></span><span class="sc3"><span class="re1">&lt;/tr<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;tr</span> <span class="re0">if</span>=<span class="st0">&quot;${lineItemIsLast}&quot;</span><span class="re2">&gt;</span></span><span class="sc3"><span class="re1">&lt;td<span class="re2">&gt;</span></span></span>Grand total<span class="sc3"><span class="re1">&lt;/td<span class="re2">&gt;</span></span></span><span class="sc3"><span class="re1">&lt;td<span class="re2">&gt;</span></span></span>etc<span class="sc3"><span class="re1">&lt;/td<span class="re2">&gt;</span></span></span><span class="sc3"><span class="re1">&lt;/tr<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/for<span class="re2">&gt;</span></span></span></pre></div></p>

<p>The for element can also have additional attributes which will evaluated as a variable assignment. Note - the named variable of the correct type must already exist. <em>Maybe at some point the code generator will keep track of declared variables in scope and create new 'var's where appropriate. I think I'll add a trac item for that.</em></p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;viewdata</span> <span class="re0">currentProductId</span>=<span class="st0">&quot;int&quot;</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;var</span> <span class="re0">styles</span>=<span class="st0">&quot;new [] {'even', 'odd'}&quot;</span> <span class="re0">isCurrent</span>=<span class="st0">&quot;false&quot;</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;for</span> <span class="re0">each</span>=<span class="st0">&quot;var product in Products&quot;</span> <span class="re0">isCurrent</span>=<span class="st0">&quot;product.Id==currentProductId&quot;</span><span class="re2">&gt;</span></span>
    <span class="sc3"><span class="re1">&lt;p</span> <span class="re0">class</span>=<span class="st0">&quot;highlighted?{isCurrent} ${styles[productIndex%2]}&quot;</span><span class="re2">&gt;</span></span>${Html.Encode(product.Name)}<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;/for<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/var<span class="re2">&gt;</span></span></span></pre></div></p>

<h3 id="Iterationwiththeeachattribute">Iteration with the each attribute</h3>

<p>You may also add the each attribute to any plain element.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;table<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;tr<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;td<span class="re2">&gt;</span></span></span>Name<span class="sc3"><span class="re1">&lt;/td<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;td<span class="re2">&gt;</span></span></span>Type<span class="sc3"><span class="re1">&lt;/td<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;/tr<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;tr</span> <span class="re0">each</span>=<span class="st0">'var user in users'</span><span class="re2">&gt;</span></span>
    <span class="sc3"><span class="re1">&lt;td<span class="re2">&gt;</span></span></span>${user.Name}<span class="sc3"><span class="re1">&lt;/td<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;td<span class="re2">&gt;</span></span></span>${user.UserType}<span class="sc3"><span class="re1">&lt;/td<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;/tr<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/table<span class="re2">&gt;</span></span></span></pre></div></p>

<p>If you do that other attributes are not treated as variable assignment, but they may contain ${expression} evaluation.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;table<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;tr<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;td<span class="re2">&gt;</span></span></span>Name<span class="sc3"><span class="re1">&lt;/td<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;td<span class="re2">&gt;</span></span></span>Type<span class="sc3"><span class="re1">&lt;/td<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;/tr<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;var</span> <span class="re0">classes</span>=<span class="st0">&quot;new [] {'even','odd'}&quot;</span><span class="re2">&gt;</span></span>
    <span class="sc3"><span class="re1">&lt;tr</span> <span class="re0">each</span>=<span class="st0">&quot;var user in users&quot;</span> <span class="re0">class</span>=<span class="st0">&quot;${classes[userIndex%2]}&quot;</span><span class="re2">&gt;</span></span>
      <span class="sc3"><span class="re1">&lt;td<span class="re2">&gt;</span></span></span>${userIndex}) ${user.Name}<span class="sc3"><span class="re1">&lt;/td<span class="re2">&gt;</span></span></span>
      <span class="sc3"><span class="re1">&lt;td<span class="re2">&gt;</span></span></span>${user.UserType}<span class="sc3"><span class="re1">&lt;/td<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;/tr<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;/var<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/table<span class="re2">&gt;</span></span></span></pre></div></p>

<h3 id="Usingnamespace">Using namespace</h3>

<p>You can add using statements to avoid typing out fully qualified type names, and to make extension methods to helpers available.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;use</span> <span class="re0">namespace</span>=<span class="st0">&quot;System.Collections.Generic&quot;</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;use</span> <span class="re0">namespace</span>=<span class="st0">&quot;System.Web.Mvc&quot;</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;viewdata</span> <span class="re0">Names</span>=<span class="st0">&quot;IList[[string]]&quot;</span><span class="re2">/&gt;</span></span></pre></div></p>

<p>The use namespace elements may appear anywhere in the view, master, or partial template files. The namespaces are de-duplicated so it's safe to include them where they're needed in views and partials if you prefer even though the same namespace could appear several times.</p>

<h3 id="Inlinecode">Inline code</h3>

<p>Sometimes, when push comes to shove, you have a situation where you're not writing output and there isn't a markup construct for what you want to do. As a last resort you can produce code directly in-place in the generated class.</p>

<p>This takes two forms. An aspx-like <%statement%> version is available as well as a #statement<end-of-line> variation.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;test</span> <span class="re0">if</span>=<span class="st0">&quot;user.IsLoggedIn()&quot;</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>Hello, ${user.Name}.<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;else</span> <span class="re0">if</span>=<span class="st0">&quot;user.HasValidTrialSession()&quot;</span><span class="re2">/&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>Hello, Valued Future Customer.<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;else</span><span class="re2">/&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>Hello, er... you.<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
  # System.Diagnostic.Trace.WriteLine(&quot;Unexpected anon user.&quot;);
  # if (System.Diagnostic.Debugger.IsAttached)
  #   System.Diagnostic.Debugger.Break();
<span class="sc3"><span class="re1">&lt;/test<span class="re2">&gt;</span></span></span></pre></div></p>

<h3 id="DeclaringMacros">Declaring Macros</h3>

<p>When it comes right down to it a helper method is a function that takes arguments and returns a string. A Spark &lt;macro&gt; produces something which is much the same: a function that takes arguments and returns a string.</p>

<p>Because a macro is declared in a the spark template it's contents may contain any literal html, rendering of partial files, expression evaluation, etc. All of the output from this is captured as the simple return value. This enables you to invoke a &lt;macro name="foo"&gt; using ${foo()} or &lt;%=foo()%&gt; from anywhere in your template files.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;viewdata</span> <span class="re0">errorMessage</span>=<span class="st0">&quot;string&quot;</span> <span class="re2">/&gt;</span></span>
&nbsp;
<span class="sc3"><span class="re1">&lt;macro</span> <span class="re0">name</span>=<span class="st0">&quot;ShowError&quot;</span> <span class="re0">caption</span>=<span class="st0">&quot;string&quot;</span> <span class="re0">message</span>=<span class="st0">&quot;string&quot;</span><span class="re2">&gt;</span></span>
<span class="sc3"><span class="re1">&lt;div</span> <span class="re0">class</span>=<span class="st0">&quot;message error&quot;</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;h3<span class="re2">&gt;</span></span></span>${H(caption)}<span class="sc3"><span class="re1">&lt;/h3<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;div<span class="re2">&gt;</span></span></span>${message}<span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;</span>% Logger.Warn<span class="br0">&#40;</span>caption<span class="br0">&#41;</span>; %<span class="re2">&gt;</span></span> <span class="sc3"><span class="coMULTI">&lt;!-- this is a MR example. asp.net mvc would use different logging --&gt;</span></span>
<span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/macro<span class="re2">&gt;</span></span></span>
&nbsp;
<span class="sc3"><span class="re1">&lt;h2<span class="re2">&gt;</span></span></span>Place Order<span class="sc3"><span class="re1">&lt;/h2<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;test</span> <span class="re0">if</span>=<span class="st0">&quot;!string.IsNullOrEmpty(errorMessage)&quot;</span><span class="re2">&gt;</span></span>
  ${ShowError(&quot;Failed to place order&quot;, errorMessage)}
<span class="sc3"><span class="re1">&lt;/test<span class="re2">&gt;</span></span></span>
&nbsp;
<span class="sc3"><span class="coMULTI">&lt;!-- form here, field validation messages, etc. --&gt;</span></span></pre></div></p>

<p>The following method generated code is the result</p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw4">string</span> ShowError<span class="br0">&#40;</span><span class="kw4">string</span> caption, <span class="kw4">string</span> message<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
  <span class="kw1">using</span><span class="br0">&#40;</span>OutputScope<span class="br0">&#40;</span><span class="kw3">new</span> <span class="kw5">System</span>.<span class="me1">IO</span>.<span class="me1">StringWriter</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> 
  <span class="br0">&#123;</span> 
    Output.<span class="me1">Write</span><span class="br0">&#40;</span><span class="st0">&quot;<span class="es0">\r</span><span class="es0">\n</span>  &lt;div class=<span class="es0">\&quot;</span>message error<span class="es0">\&quot;</span>&gt;<span class="es0">\r</span><span class="es0">\n</span>    &lt;h3&gt;&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    Output.<span class="me1">Write</span><span class="br0">&#40;</span>H<span class="br0">&#40;</span>caption<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    Output.<span class="me1">Write</span><span class="br0">&#40;</span><span class="st0">&quot;&lt;/h3&gt;<span class="es0">\r</span><span class="es0">\n</span>    &lt;div&gt;&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    Output.<span class="me1">Write</span><span class="br0">&#40;</span>message<span class="br0">&#41;</span><span class="sy0">;</span>
    Output.<span class="me1">Write</span><span class="br0">&#40;</span><span class="st0">&quot;&lt;/div&gt;<span class="es0">\r</span><span class="es0">\n</span>    &quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    Logger.<span class="me1">Warn</span><span class="br0">&#40;</span>caption<span class="br0">&#41;</span><span class="sy0">;</span>
    Output.<span class="me1">Write</span><span class="br0">&#40;</span><span class="st0">&quot;  &lt;/div&gt;<span class="es0">\r</span><span class="es0">\n</span>&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw1">return</span> Output.<span class="me1">ToString</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span> 
  <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="co1">//... and in the RenderViewContent method</span>
Output.<span class="me1">Write</span><span class="br0">&#40;</span><span class="st0">&quot;<span class="es0">\r</span><span class="es0">\n</span>&lt;h2&gt;Place Order&lt;/h2&gt;<span class="es0">\r</span><span class="es0">\n</span>&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="kw4">string</span>.<span class="me1">IsNullOrEmpty</span><span class="br0">&#40;</span>errorMessage<span class="br0">&#41;</span><span class="br0">&#41;</span> 
<span class="br0">&#123;</span>
  Output.<span class="me1">Write</span><span class="br0">&#40;</span>ShowError<span class="br0">&#40;</span><span class="st0">&quot;Failed to place order&quot;</span>, errorMessage<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span> <span class="co1">// if (!string.IsNullOrEmpty(errorMessage))</span>
Output.<span class="me1">Write</span><span class="br0">&#40;</span><span class="st0">&quot;<span class="es0">\r</span><span class="es0">\n</span><span class="es0">\r</span><span class="es0">\n</span>&lt;!-- form here, field validation messages, etc. --&gt;<span class="es0">\r</span><span class="es0">\n</span><span class="es0">\r</span><span class="es0">\n</span>&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre></div></p>

<p>A macro may also call itself recursively, which is convenient for producing something like a threaded comment list or a nested ul/ul/li tree structure.</p>
  </div>
<div id="node-34" class="section-2">
  <h1 class="book-heading">Master Layouts</h1>
  <div class="toc">
<div class="toc-title">Table of Contents [<a href="#" class="toc-toggle">hide</a>]</div>
<div class="toc-list">
<ul>

<ul>

<ul>
	<li><a href="#Preface">Preface</a></li>
	<li><a href="#Howmasterlayoutfileswork">How master-layout files work</a></li>
	<li><a href="#SelectingLayout">Selecting Layout</a></li>
	<li><a href="#Threepassrendering">Three pass rendering</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<h3 id="Preface">Preface</h3>

<p>This entire subject is ASP.NET MVC specific. MonoRail has it's own mechanism for selecting layout files, and Spark works in that context as expected.</p>

<h3 id="Howmasterlayoutfileswork">How master-layout files work</h3>

<p>When a view is rendered with a master layout template selected Spark renders the view in a multiple passes. The first pass will render the contents of the view template from the top down. The output of that pass is captured in a content variable named "view".</p>

<p>The second pass will render the contents of the master template from the top down. The master template will contain <code>&lt;use content="view"/&gt;</code> or <code>&lt;use:view/&gt;</code> at the location where the view content should appear.</p>

<p><strong>Application.spark</strong>
<div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;html<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;head<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;title<span class="re2">&gt;</span></span></span>${Title}<span class="sc3"><span class="re1">&lt;/title<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;/head<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;body<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;div</span> <span class="re0">id</span>=<span class="st0">&quot;header&quot;</span><span class="re2">&gt;</span></span>dot dot dot<span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;div</span> <span class="re0">id</span>=<span class="st0">&quot;pageContent&quot;</span><span class="re2">&gt;</span></span><span class="sc3"><span class="re1">&lt;use</span> <span class="re0">content</span>=<span class="st0">&quot;view&quot;</span><span class="re2">/&gt;</span></span><span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;div</span> <span class="re0">id</span>=<span class="st0">&quot;footer&quot;</span><span class="re2">&gt;</span></span>dot dot dot<span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;/body<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/html<span class="re2">&gt;</span></span></span></pre></div></p>

<p>From the master template's perpective the "view" is just a piece of named content.</p>

<h3 id="SelectingLayout">Selecting Layout</h3>

<p>There are several ways to select a which master layout file should be used. The following are the ways a template may be selected, from weakest to strongest.</p>

<ul>
<li>An Application.spark file in the Views/Layouts folder or Views/Shared folder</li>
</ul>

<p>This is the most general-purpose way to have a site-wide master template. It will not be used if the controller returns a PartialView().</p>

<ul>
<li>A .spark file in Views/Layouts or Views/Shared with the same name as the controller</li>
</ul>

<p>For example if you have an AccountController you could have a Views/Layouts/Account.spark file which is used on that controller, but all other controllers use the Views/Layouts/Application.spark template.</p>

<ul>
<li>Naming the master layout as the second argument when you return a View() as the ActionResult</li>
</ul>

<p>This gives the selection of layout to the controller, which some people may believe isn't necessarily a concern for the controller. What'cha gonna do? If this is present it will override the first two conventions.</p>

<ul>
<li>Naming the master layout as an <code>&lt;use master=""/&gt;</code> element in the view.</li>
</ul>

<p>This is actually the strongest mechanism available for wrapping a view in a layout file. It will override the conventional forms of master selection, and it will cause the name of the master in the View() ActionResult to be ignored if it's present.</p>

<p>Interestingly, it may also be used in the layout files themselves to establish three or more pass rendering.</p>

<h3 id="Threepassrendering">Three pass rendering</h3>

<p>Three pass rendering can be used to address a common problem. The cause isn't always obvious, especially if you're new to the named-content top-down rendering technique.</p>

<p>The problem is this. Let's say you're using a named content section, like "head" or "nav", at the top of your master layout file. Then you add some partials in the sidebar or other places in the layout that add script and stylesheet references to the "head" content. The problem you'll encounter is that the "head" is actually written to the output stream before those bits further down the layout execute and add those resources to the named content.</p>

<p><strong>Views/Layouts/Application.spark</strong>
<div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;html<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;head<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;use</span> <span class="re0">content</span>=<span class="st0">&quot;head&quot;</span><span class="re2">/&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;/head<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;body<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;Header</span><span class="re2">/&gt;</span></span>
    <span class="sc3"><span class="re1">&lt;use</span> <span class="re0">content</span>=<span class="st0">&quot;view&quot;</span><span class="re2">/&gt;</span></span>
    <span class="sc3"><span class="re1">&lt;Sidebar</span><span class="re2">/&gt;</span></span>
    <span class="sc3"><span class="re1">&lt;Footer</span><span class="re2">/&gt;</span></span>
    <span class="sc3"><span class="re1">&lt;use</span> <span class="re0">content</span>=<span class="st0">&quot;tail&quot;</span><span class="re2">/&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;/body<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/html<span class="re2">&gt;</span></span></span></pre></div></p>

<p><strong>Views/Shared/_Sidebar.spark</strong>
<div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;content</span> <span class="re0">name</span>=<span class="st0">&quot;head&quot;</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;script</span> <span class="re0">src</span>=<span class="st0">&quot;~/content/js/jquery-ui-accordian.js&quot;</span> <span class="re0">once</span>=<span class="st0">&quot;jquery-accordian&quot;</span><span class="re2">&gt;</span></span><span class="sc3"><span class="re1">&lt;/script<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/content<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;div</span> <span class="re0">id</span>=<span class="st0">&quot;sidebar&quot;</span><span class="re2">&gt;</span></span>etc<span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span></pre></div></p>

<p>One way to use three-pass rendering to solve this problem would be to create a super-layout named <code>Html.spark</code>, and for the master file <code>Application.spark</code> to wrap itself in that layout. Note that from the <code>Html.spark</code> file's perspective the entire output of the <code>Application.spark</code>, and the view which it encloses, is contained in the "view" named content.</p>

<p><strong>Views/Layouts/Html.spark</strong>
<div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;html<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;head<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;use</span> <span class="re0">content</span>=<span class="st0">&quot;head&quot;</span><span class="re2">/&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;/head<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;body<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;use</span> <span class="re0">content</span>=<span class="st0">&quot;view&quot;</span><span class="re2">/&gt;</span></span>
    <span class="sc3"><span class="re1">&lt;use</span> <span class="re0">content</span>=<span class="st0">&quot;tail&quot;</span><span class="re2">/&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;/body<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/html<span class="re2">&gt;</span></span></span></pre></div></p>

<p><strong>Views/Layouts/Application.spark</strong>
<div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;use</span> <span class="re0">master</span>=<span class="st0">&quot;Html&quot;</span><span class="re2">/&gt;</span></span>
&nbsp;
<span class="sc3"><span class="re1">&lt;Header</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;use</span> <span class="re0">content</span>=<span class="st0">&quot;view&quot;</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;Sidebar</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;Footer</span><span class="re2">/&gt;</span></span></pre></div></p>
  </div>
<div id="node-7" class="section-2">
  <h1 class="book-heading">Organizing Content</h1>
  <p><div class="toc">
<div class="toc-title">Table of Contents [<a href="#" class="toc-toggle">hide</a>]</div>
<div class="toc-list">
<ul>

<ul>

<ul>
	<li><a href="#MasterViewrelationship">Master-View relationship</a></li>
	<li><a href="#Namedcontentsections">Named content sections</a></li>
	<li><a href="#Parsingandrenderingpartialfiles">Parsing and rendering partial files</a></li>
	<li><a href="#Implicitpartialrendering">Implicit partial rendering</a></li>
	<li><a href="#Importingfiles">Importing files</a></li>
	<li><a href="#Includingfiles">Including files</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div></p>

<h3 id="MasterViewrelationship">Master-View relationship</h3>

<p>The view contents are rendered first, followed by the master contents. The master template includes the view at the appropriate location with ${Content["view"]}, or <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;use</span> <span class="re0">content</span>=<span class="st0">&quot;view&quot;</span><span class="re2">/&gt;</span></span></code></span>, or <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;use:view</span><span class="re2">/&gt;</span></span></code></span>.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;html<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;head<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;title<span class="re2">&gt;</span></span></span>${Title}<span class="sc3"><span class="re1">&lt;/title<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;/head<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;body<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;div</span> <span class="re0">id</span>=<span class="st0">&quot;header&quot;</span><span class="re2">&gt;</span></span>dot dot dot<span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;div</span> <span class="re0">id</span>=<span class="st0">&quot;pageContent&quot;</span><span class="re2">&gt;</span></span><span class="sc3"><span class="re1">&lt;use</span> <span class="re0">content</span>=<span class="st0">&quot;view&quot;</span><span class="re2">/&gt;</span></span><span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;div</span> <span class="re0">id</span>=<span class="st0">&quot;footer&quot;</span><span class="re2">&gt;</span></span>dot dot dot<span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;/body<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/html<span class="re2">&gt;</span></span></span></pre></div></p>

<h3 id="Namedcontentsections">Named content sections</h3>

<p>Defining additional number of content sections or modules is one way you can create extensible blocks or regions in your layout. It's also a convenient way to enable a view to include additional css and js references in the head section.</p>

<p>This example shows a master layout which provides the ability for the views to add script and style to the head element, and add sections to a sidebar container.</p>

<p>Making named content appear in output</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;html<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;head<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;title<span class="re2">&gt;</span></span></span>${Title}<span class="sc3"><span class="re1">&lt;/title<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;use</span> <span class="re0">content</span>=<span class="st0">&quot;head&quot;</span><span class="re2">/&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;/head<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;body<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;div</span> <span class="re0">id</span>=<span class="st0">&quot;header&quot;</span><span class="re2">&gt;</span></span>dot dot dot<span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;div</span> <span class="re0">id</span>=<span class="st0">&quot;sidebar&quot;</span><span class="re2">&gt;</span></span><span class="sc3"><span class="re1">&lt;use</span> <span class="re0">content</span>=<span class="st0">&quot;sidebar&quot;</span><span class="re2">/&gt;</span></span><span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;div</span> <span class="re0">id</span>=<span class="st0">&quot;pageContent&quot;</span><span class="re2">&gt;</span></span><span class="sc3"><span class="re1">&lt;use</span> <span class="re0">content</span>=<span class="st0">&quot;view&quot;</span><span class="re2">/&gt;</span></span><span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;div</span> <span class="re0">id</span>=<span class="st0">&quot;footer&quot;</span><span class="re2">&gt;</span></span>dot dot dot<span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;/body<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/html<span class="re2">&gt;</span></span></span></pre></div></p>

<p>Adding information to named content locations</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>this goes in the pageContent<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
&nbsp;
<span class="sc3"><span class="re1">&lt;content</span> <span class="re0">name</span>=<span class="st0">&quot;sidebar&quot;</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;h3<span class="re2">&gt;</span></span></span>Search<span class="sc3"><span class="re1">&lt;/h3<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>This is added to the sidebar<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;content<span class="re2">&gt;</span></span></span>
&nbsp;
<span class="sc3"><span class="re1">&lt;content</span> <span class="re0">name</span>=<span class="st0">&quot;head&quot;</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;script</span> <span class="re0">type</span>=<span class="st0">&quot;text/javascript&quot;</span> <span class="re0">src</span>=<span class="st0">&quot;yadda/file.js&quot;</span><span class="re2">&gt;</span></span><span class="sc3"><span class="re1">&lt;/script<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;content<span class="re2">&gt;</span></span></span>
&nbsp;
<span class="sc3"><span class="re1">&lt;content</span> <span class="re0">name</span>=<span class="st0">&quot;sidebar&quot;</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;h3<span class="re2">&gt;</span></span></span>See also<span class="sc3"><span class="re1">&lt;/h3<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>This is also added to the sidebar<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;content<span class="re2">&gt;</span></span></span></pre></div></p>

<p>The implementation details of this are very straightforward. The generated class is appending values to the current textwriter. When a <content name="foo"> element is encountered it changes which textwriter is current. Later when a &lt;use content="foo"/&gt; or ${Content["foo"]} is encountered the accumulated text in the named content is written to the textwriter that is current at the time. </p>

<p>There is one intrinsic content section named "view". It will contain the output of the previous level when rendering view/master. In MonoRail there can be several layouts named, and the section named "view" will always contain the total result of the previous levels.</p>

<p>You can also use the prefixes as an alias for &lt;content name="foo"&gt; and &lt;use content="foo"&gt;. Those would be content:foo and use:foo respectively.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;content:message<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>This is a message<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/content:message<span class="re2">&gt;</span></span></span>
&nbsp;
<span class="sc3"><span class="re1">&lt;content:message<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>This is another message<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/content:message<span class="re2">&gt;</span></span></span>
&nbsp;
<span class="sc3"><span class="re1">&lt;div</span> <span class="re0">class</span>=<span class="st0">&quot;messages&quot;</span> <span class="re0">if</span>=<span class="st0">&quot;Content.ContainsKey('message')&quot;</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;use:message</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span></pre></div></p>

<h3 id="Parsingandrenderingpartialfiles">Parsing and rendering partial files</h3>

<p>You can include and render a partial file at a particular location with the following syntax:</p>

<p>viewfile</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;use</span> <span class="re0">file</span>=<span class="st0">&quot;mypartial&quot;</span><span class="re2">/&gt;</span></span></pre></div></p>

<p>This will look for a mypartial.xml file in the same directory as the view or in the Shared directory.</p>

<p>You can also declare local variables as attributes of the "use" element. Those variables, and anything else that was in context, can be used within the scope of the partial as local variables.</p>

<p>viewfile</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;use</span> <span class="re0">file</span>=<span class="st0">&quot;mypartial&quot;</span> <span class="re0">caption</span>=<span class="st0">&quot;product.Name&quot;</span><span class="re2">/&gt;</span></span></pre></div></p>

<p>mypartial.xml</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;div<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;h3<span class="re2">&gt;</span></span></span>${caption}<span class="sc3"><span class="re1">&lt;/h3<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span></pre></div></p>

<h3 id="Implicitpartialrendering">Implicit partial rendering</h3>

<p>Finally, if your partial file starts with an underscore character the rest of the file name can be used as a new special element. This is nothing more than <specialname/> being used as a shortcut for <use file="_specialname"/> but it sure looks cool.</p>

<p>viewfile</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;var</span> <span class="re0">styles</span>=<span class="st0">'new[] {&quot;even&quot;, &quot;odd&quot;}'</span> <span class="re0">i</span>=<span class="st0">'0'</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;for</span> <span class="re0">each</span>=<span class="st0">'var product in Products'</span> <span class="re0">i</span>=<span class="st0">'i+1'</span><span class="re2">&gt;</span></span>
    <span class="sc3"><span class="re1">&lt;ProductSummary</span> <span class="re0">cssclass</span>=<span class="st0">&quot;styles[i%2]&quot;</span> <span class="re0">number</span>=<span class="st0">&quot;i&quot;</span><span class="re2">/&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;/for<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/var<span class="re2">&gt;</span></span></span></pre></div></p>

<p>_ProductSummary.xml</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;div</span> <span class="re0">class</span>=<span class="st0">&quot;${cssclass}&quot;</span><span class="re2">&gt;</span></span>
<span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>${number}) ${product.Name}<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span></pre></div></p>

<p>Partial files starting with an underscore will be used from the view directory of the controller and from the "Shared" view directory. </p>

<h3 id="Importingfiles">Importing files</h3>

<p>Many of the elements like  &lt;global&gt;, &lt;viewdata&gt;, &lt;macro name=""&gt;, &lt;use namespace=""&gt;, and &lt;use assembly=""&gt; have an effect on the generated view class but do not produce output in-line.</p>

<p>You can remove a lot of these declarations from view, partial, and layout files by moving them into a spark file which you then import. </p>

<p><b>Shared\\CommonMacros.spark</b><br />
<div class="geshifilter"><pre class="geshifilter-xml">General-purpose references
<span class="sc3"><span class="re1">&lt;use</span> <span class="re0">namespace</span>=<span class="st0">&quot;System&quot;</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;use</span> <span class="re0">namespace</span>=<span class="st0">&quot;System.Collections.Generic&quot;</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;use</span> <span class="re0">assembly</span>=<span class="st0">&quot;MyWebApp&quot;</span><span class="re2">/&gt;</span></span>
&nbsp;
These are null if they're not in the viewdatadictionary or propertybag
<span class="sc3"><span class="re1">&lt;viewdata</span> <span class="re0">warning</span>=<span class="st0">&quot;string&quot;</span> <span class="re0">error</span>=<span class="st0">&quot;string&quot;</span><span class="re2">/&gt;</span></span>
&nbsp;
This macro writes out a warning or error if it's in the viewdata.
<span class="sc3"><span class="re1">&lt;macro:WarningOrError<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;div</span> <span class="re0">class</span>=<span class="st0">&quot;msgbox warning&quot;</span> <span class="re0">if</span>=<span class="st0">&quot;!string.IsNullOrEmpty(warning)&quot;</span><span class="re2">&gt;</span></span>
    ${H(warning)}
  <span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;div</span> <span class="re0">class</span>=<span class="st0">&quot;msgbox error&quot;</span> <span class="re0">if</span>=<span class="st0">&quot;!string.IsNullOrEmpty(error)&quot;</span><span class="re2">&gt;</span></span>
    ${H(error)}
  <span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/macro:WarningOrError<span class="re2">&gt;</span></span></span></pre></div></p>

<p><b>SomeView.spark</b><br />
<div class="geshifilter"><pre class="geshifilter-xml">  <span class="sc3"><span class="re1">&lt;use</span> <span class="re0">import</span>=<span class="st0">&quot;CommonMacros&quot;</span><span class="re2">/&gt;</span></span>
  ${WarningOrError()}</pre></div></p>

<p>Import files are much like partial files, except they will not generate rendering code at the points where the &lt;use import=""&gt; occurs. Any text or markup in the imported file, other than the class-level declarations, can be used more or less like comment that won't add a single thing to the generated class or the html output. You can also import the same file from any number of views, partials, and layouts and it's contents will only be used once.</p>

<p>You may also place a <b>_global.spark</b> in a controller's view folder, or the layouts view folder, and that file will be automatically imported whenever a view or layout template is used from that location. Another file <b>shared\\_global.spark</b> can be created which will be imported once into every single view that's compiled.</p>

<h3 id="Includingfiles">Including files</h3>

<p>Another way to manage content is with the &lt;include href=""&gt; element. The implementation of this element is based on a subset of the <a href="http://www.w3.org/TR/xinclude/">xinclude specification</a>. See also O'Reilly <a href="http://www.xml.com/pub/a/2002/07/31/xinclude.html">Using XInclude</a> and MSDN <a href="http://msdn.microsoft.com/en-us/library/aa302291.aspx">Combining XML Documents with XInclude</a>.</p>

<p>The include and fallback elements are both supported. The include element may have href and parse attributes. The value href must be a relative path, may contain ".." style parent paths, and must include the target file's extension. The dotted parent paths may not go beyond the root of the IViewFolder.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;h2<span class="re2">&gt;</span></span></span>Chapter One<span class="sc3"><span class="re1">&lt;/h2<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;include</span> <span class="re0">href</span>=<span class="st0">&quot;../lib/chap01.xml&quot;</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;hr</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;h3<span class="re2">&gt;</span></span></span>Disclaimer<span class="sc3"><span class="re1">&lt;/h3<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;include</span> <span class="re0">href</span>=<span class="st0">&quot;../lib/legal.txt&quot;</span> <span class="re0">parse</span>=<span class="st0">&quot;text&quot;</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;fallback<span class="re2">&gt;</span></span></span>It appears the lawyers have nothing to say.<span class="sc3"><span class="re1">&lt;/fallback<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/include<span class="re2">&gt;</span></span></span></pre></div></p>

<p>You may also use explicit namespaces. Note: declaring namespaces with xmlns attibutes is all-or-nothing. If you declare the XInclude namespace in a file you must also declare the Spark namespace and use element prefixes.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;div</span> <span class="re0">class</span>=<span class="st0">&quot;shimmer&quot;</span> <span class="re0">xmlns:s</span>=<span class="st0">&quot;http://sparkviewengine.com/&quot;</span> <span class="re0">xmlns:xi</span>=<span class="st0">&quot;http://www.w3.org/2001/XInclude&quot;</span><span class="re2">&gt;</span></span>
<span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>Let's add a stylesheet to the header<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;s:content</span> <span class="re0">name</span>=<span class="st0">&quot;head&quot;</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;style</span> <span class="re0">type</span>=<span class="st0">&quot;text/css&quot;</span><span class="re2">&gt;</span></span>
    <span class="sc3"><span class="re1">&lt;xi:include</span> <span class="re0">href</span>=<span class="st0">&quot;../lib/effects.css&quot;</span> <span class="re0">parse</span>=<span class="st0">&quot;text&quot;</span><span class="re2">/&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;/style<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/s:content<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span></pre></div></p>

<p>When a file is including another file it happens before <em>any</em> significant processing takes place. As far as the Spark view engine is concerned the contents of the target file may as well have been copy-and-pasted right at the location of the include element. This can have some advantages, but be cautions about duplicate macro declarations or circular include references.</p>
  </div>
<div id="node-43" class="section-2">
  <h1 class="book-heading">Output Caching</h1>
  <div class="messages warning">Requires Spark version 1.1</div>

<div class="toc">
<div class="toc-title">Table of Contents [<a href="#" class="toc-toggle">hide</a>]</div>
<div class="toc-list">
<ul>

<ul>

<ul>
	<li><a href="#Cachingpartofatemplate">Caching part of a template</a></li>
	<li><a href="#Cachingthatvariesbyparameters">Caching that varies by parameters</a></li>
	<li><a href="#Givingcacheaspecifictimetolive">Giving cache a specific time-to-live</a></li>
	<li><a href="#Expiringwhenunusedovertime">Expiring when unused over time</a></li>
	<li><a href="#UsingValueHolderforcleanviews">Using ValueHolder for clean views</a></li>
	<li><a href="#Signalingdependentdatachanged">Signaling dependent data changed</a></li>
	<li><a href="#Usingcachewithxmlattributes">Using cache with xml attributes</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<h3 id="Cachingpartofatemplate">Caching part of a template</h3>

<p>Output from a Spark template may be cached by wrapping it in a <code>&lt;cache&gt;</code> 
element. Let's assuming you have a ShowConversionTable macro that does some expensive data acquisition through a service class.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;viewdata</span> <span class="re0">Conversion</span>=<span class="st0">&quot;IConversionRateService&quot;</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;h1<span class="re2">&gt;</span></span></span>A cached section<span class="sc3"><span class="re1">&lt;/h1<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>Current conversion rate ${Conversion.CurrentRate}<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
!{ShowConversionTable(Conversion)}</pre></div></p>

<p>You could cache the results of this html output by wrapping the section.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;viewdata</span> <span class="re0">Conversion</span>=<span class="st0">&quot;IConversionRateService&quot;</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;h1<span class="re2">&gt;</span></span></span>A cached section<span class="sc3"><span class="re1">&lt;/h1<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;cache<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>Current conversion rate ${Conversion.CurrentRate}<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
  !{ShowConversionTable(Conversion)}
<span class="sc3"><span class="re1">&lt;/cache<span class="re2">&gt;</span></span></span></pre></div></p>

<p>The second and subsequent times this template renders it will reuse the output from the first time it ran. This output would be stored in the ASP.NET cache the first time the cached segment had run.</p>

<p>Note! It's generally considered a bad practice for the view to acquire the data or model which it is exposing. In further examples below we will see a way to keep data acquisition in your controller's action in a way that caching will still avoid the data acquisition costs.</p>

<h3 id="Cachingthatvariesbyparameters">Caching that varies by parameters</h3>

<p>Frequently you'll want to cache things which don't show the same data on every request, or don't appear the same to all users. For example, let's say our conversion table has a parameter to determine the currency to use as the baseline denomination. In that case you would provide the additional key values that would make the output to cache unique.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;viewdata</span> 
    <span class="re0">Conversion</span>=<span class="st0">&quot;IConversionRateService&quot;</span> 
    <span class="re0">Baseline</span>=<span class="st0">&quot;string&quot;</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;h1<span class="re2">&gt;</span></span></span>A cached section<span class="sc3"><span class="re1">&lt;/h1<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;cache</span> <span class="re0">key</span>=<span class="st0">&quot;Baseline&quot;</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>Current rate over Euro ${Conversion.GetCurrentRate(Baseline, &quot;EUR&quot;)}<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
  !{ShowConversionTable(Conversion, Baseline)}
<span class="sc3"><span class="re1">&lt;/cache<span class="re2">&gt;</span></span></span></pre></div></p>

<p>Several parameters may be delimited by commas. This works because attribute value is used as a <code>params object[] keys</code> argument, so if commas are present it create a multiple-field key for the cache entry.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;viewdata</span> 
    <span class="re0">Conversion</span>=<span class="st0">&quot;IConversionRateService&quot;</span> 
    <span class="re0">Baseline</span>=<span class="st0">&quot;string&quot;</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;h1<span class="re2">&gt;</span></span></span>A cached section<span class="sc3"><span class="re1">&lt;/h1<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;cache</span> <span class="re0">key</span>=<span class="st0">&quot;Baseline, CurrentUserProfile.CountryOfOrigin.Currency&quot;</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;var</span> <span class="re0">userCurrency</span>=<span class="st0">&quot;CurrentUserProfile.CountryOfOrigin.Currency&quot;</span><span class="re2">/&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>${Baseline} rate over ${userCurrency} ${Conversion.GetCurrentRate(Baseline, userCurrency)}<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
  !{ShowConversionTable(Conversion, Baseline)}
<span class="sc3"><span class="re1">&lt;/cache<span class="re2">&gt;</span></span></span></pre></div></p>

<h3 id="Givingcacheaspecifictimetolive">Giving cache a specific time-to-live</h3>

<p>In the first example the same information could be returned for the life of the web host's app domain. In a lot of cases there's a certain point where you would consider the age of the data to be acceptable. To ensure the same output will only be used for five minutes from when it was originally capured you would provide an expires attribute with a DateTime coordinate, preferable in Utc.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;viewdata</span> 
    <span class="re0">Conversion</span>=<span class="st0">&quot;IConversionRateService&quot;</span> 
    <span class="re0">Baseline</span>=<span class="st0">&quot;string&quot;</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;h1<span class="re2">&gt;</span></span></span>A cached section<span class="sc3"><span class="re1">&lt;/h1<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;cache</span> <span class="re0">key</span>=<span class="st0">&quot;Baseline&quot;</span> <span class="re0">expires</span>=<span class="st0">&quot;DateTime.UtcNow.AddMinutes(5)&quot;</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>Current rate over Euro ${Conversion.GetCurrentRate(Baseline, &quot;EUR&quot;)}<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
  !{ShowConversionTable(Conversion, Baseline)}
<span class="sc3"><span class="re1">&lt;/cache<span class="re2">&gt;</span></span></span></pre></div></p>

<p>The expires attribute may be used with or without a key. In this example having both present would be correct.</p>

<h3 id="Expiringwhenunusedovertime">Expiring when unused over time</h3>

<p>You may have part of a view that isn't particularly time sensitive, but you don't want the entries to remain in memory when their key value hasn't been used for a while. That could be a case to consider using a TimeSpan instead of a DateTime for the expires parameter.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;h1<span class="re2">&gt;</span></span></span>Product Details<span class="sc3"><span class="re1">&lt;/h1<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;cache</span> <span class="re0">key</span>=<span class="st0">&quot;productId&quot;</span> <span class="re0">expires</span>=<span class="st0">&quot;TimeSpan.FromMinutes(20)&quot;</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>${product.Name}<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;div</span> <span class="re0">class</span>=<span class="st0">&quot;productimage&quot;</span><span class="re2">&gt;</span></span>${ShowProductImage(product.Id)}<span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>${product.Description}<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;div</span> <span class="re0">class</span>=<span class="st0">&quot;orderhistory&quot;</span><span class="re2">&gt;</span></span>
    ${ShowThirtyDayOrderingHistory(product.Id)}
  <span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/cache<span class="re2">&gt;</span></span></span></pre></div></p>

<p>For convenience a numeric value will be treated as the value of a TimeSpan in seconds.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;cache</span> <span class="re0">expires</span>=<span class="st0">&quot;600&quot;</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>
    This will remain cached until you stop 
    using the page for ten minutes.
  <span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/cache<span class="re2">&gt;</span></span></span></pre></div></p>

<p>Note! This example is again implying the view is acquiring data. A preferred method would be to have this information represented by a model added to the ViewData by the controller's action. Next we will look at avoiding that problem.</p>

<h3 id="UsingValueHolderforcleanviews">Using ValueHolder for clean views</h3>

<p>As often as possible you will want to ensure the controller's action is gathering all of the model information needed for the view to render itself. This causes a problem when you are attempting to utilize caching, because it's often the gathering of the model's data where the real cost occurs.</p>

<p>One way to ensure caching will avoid this cost is to have the view gather the data needed for the portion of the template which is cached. That way then a cache-hit occurs you also avoid the cost of making WCF or database calls to acquire the data.</p>

<p>A better way however would be to take advantage of a class like the <code>ValueHolder</code> provided by the <code>spark.dll</code> assembly. It's a class with a generic typed Value property, and the constructor accepts a lambda expression which will be called at most once the first time the value is used. The lambda may also reference local variables and action arguments even though it's technically being called when the view result is executing.</p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw1">public</span> ActionResult Details<span class="br0">&#40;</span><span class="kw4">int</span> id<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    <span class="kw4">var</span> data <span class="sy0">=</span> <span class="kw3">new</span> NorthwindDataContext<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    ViewData<span class="br0">&#91;</span><span class="st0">&quot;employeeId&quot;</span><span class="br0">&#93;</span> <span class="sy0">=</span> id<span class="sy0">;</span>
&nbsp;
    ViewData<span class="br0">&#91;</span><span class="st0">&quot;employee&quot;</span><span class="br0">&#93;</span> <span class="sy0">=</span> ValueHolder.<span class="kw1">For</span><span class="br0">&#40;</span>
        <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">=&gt;</span> data.<span class="me1">Employees</span>.<span class="me1">Single</span><span class="br0">&#40;</span>x <span class="sy0">=&gt;</span> x.<span class="me1">EmployeeID</span> <span class="sy0">==</span> id<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    <span class="kw1">return</span> View<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></div></p>

<p>One of the ways you could use this in a view is like this. Because the value property is only used in a cached section, the database not called if the same employee is viewed within three minutes.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;viewdata</span> 
    <span class="re0">employeeId</span>=<span class="st0">&quot;int&quot;</span> 
    <span class="re0">employee</span>=<span class="st0">&quot;Spark.ValueHolder[[Employee]]&quot;</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;cache</span> <span class="re0">key</span>=<span class="st0">&quot;employeeId&quot;</span> <span class="re0">expires</span>=<span class="st0">&quot;180&quot;</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>${employee.Value.Name}<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
  !{ShowSalesHistory(employee.Value)}
<span class="sc3"><span class="re1">&lt;/cache<span class="re2">&gt;</span></span></span></pre></div></p>

<p>There's also an interesting trick with the <code>&lt;viewdata&gt;</code> element you can use if you want to take advantage of Eval's ability to access properties directly. In this case it will add a <code>public Employee employee { get }</code> property which will <code>return (Employee)ViewData.Eval("employee.Value");</code>.</p>

<p>The net result is that you can use the property <code>employee</code> directly without adding the <code>.Value</code> onto it.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;viewdata</span> 
    <span class="re0">employeeId</span>=<span class="st0">&quot;int&quot;</span> 
    employee.<span class="re0">Value</span>=<span class="st0">&quot;Employee employee&quot;</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;cache</span> <span class="re0">key</span>=<span class="st0">&quot;employeeId&quot;</span> <span class="re0">expires</span>=<span class="st0">&quot;180&quot;</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>${employee.Name}<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
  !{ShowSalesHistory(employee)}
<span class="sc3"><span class="re1">&lt;/cache<span class="re2">&gt;</span></span></span></pre></div></p>

<p>You can also create a <code>ValueHolder</code> with a typed Key property, and use other class methods to acquire the data instead of a lambda expression.</p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw1">public</span> ActionResult Details<span class="br0">&#40;</span><span class="kw4">int</span> id<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    ViewData<span class="br0">&#91;</span><span class="st0">&quot;employee&quot;</span><span class="br0">&#93;</span> <span class="sy0">=</span> ValueHolder.<span class="kw1">For</span><span class="sy0">&lt;</span><span class="kw4">int</span>, Employee<span class="sy0">&gt;</span><span class="br0">&#40;</span>id, FetchEmployee<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    <span class="kw1">return</span> View<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw1">private</span> <span class="kw1">static</span> Employee FetchEmployee<span class="br0">&#40;</span><span class="kw4">int</span> employeeID<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    <span class="kw4">var</span> data <span class="sy0">=</span> <span class="kw3">new</span> NorthwindDataContext<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw1">return</span> data.<span class="me1">Employees</span>.<span class="me1">Single</span><span class="br0">&#40;</span>x <span class="sy0">=&gt;</span> x.<span class="me1">EmployeeID</span> <span class="sy0">==</span> employeeID<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></div></p>

<p>And you can use this key property from the <code>ValueHolder&lt;TKey, TValue&gt;</code> class like this.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;viewdata</span> <span class="re0">employee</span>=<span class="st0">&quot;Spark.ValueHolder[[int, Employee]]&quot;</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;cache</span> <span class="re0">key</span>=<span class="st0">&quot;employee.Key&quot;</span> <span class="re0">expires</span>=<span class="st0">&quot;180&quot;</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>${employee.Value.Name}<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
  !{ShowSalesHistory(employee.Value)}
<span class="sc3"><span class="re1">&lt;/cache<span class="re2">&gt;</span></span></span></pre></div></p>

<p>Or you could use the Eval trick again like this.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;viewdata</span> 
    employee.<span class="re0">Key</span>=<span class="st0">&quot;int employeeId&quot;</span>
    employee.<span class="re0">Value</span>=<span class="st0">&quot;Employee employee&quot;</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;cache</span> <span class="re0">key</span>=<span class="st0">&quot;employeeId&quot;</span> <span class="re0">expires</span>=<span class="st0">&quot;180&quot;</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>${employee.Name}<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
  !{ShowSalesHistory(employee)}
<span class="sc3"><span class="re1">&lt;/cache<span class="re2">&gt;</span></span></span></pre></div></p>

<h3 id="Signalingdependentdatachanged">Signaling dependent data changed</h3>

<p>Expiring the cached output when it reaches a certain age, or when unused for a certain period, always involves a trade-off. With a shorted expiration you're losing cache efficiency, because it's being re-generated more frequently, and with longer expiration you're accepting the fact the web site will return information that's out of date for a certain period. That can be
especially noticeable if your web site is on a server farm, because the different nodes may return different cached results if you refresh a page repeatedly.</p>

<p>To have ultimate control over your cached data you may provide an ICacheSignal that will fire an event when the data changes. Say you have a component that has a <code>RegionSalesBuilder.GetFigures(int regionId)</code> method, and you also implement a <code>RegionSalesWatcher.GetSignalForRegion(int regionId)</code> that will return an ICacheSignal.</p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw1">public</span> ActionResult SalesFigures<span class="br0">&#40;</span><span class="kw4">int</span> id<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
  <span class="kw4">var</span> worker <span class="sy0">=</span> <span class="kw3">new</span> RegionSalesBuilder<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
  <span class="kw4">var</span> watcher <span class="sy0">=</span> <span class="kw3">new</span> RegionSalesWatcher<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
  <span class="kw1">return</span> View<span class="br0">&#40;</span><span class="kw3">new</span> <span class="br0">&#123;</span>
    regionId <span class="sy0">=</span> id,
    figures <span class="sy0">=</span> ValueHolder.<span class="kw1">For</span><span class="sy0">&lt;</span><span class="kw4">int</span>, RegionSales<span class="sy0">&gt;</span><span class="br0">&#40;</span>id, worker.<span class="me1">GetFigures</span><span class="br0">&#41;</span>,
    salesChanged <span class="sy0">=</span> watcher.<span class="me1">GetSignalForRegion</span><span class="br0">&#40;</span>id<span class="br0">&#41;</span>,
    <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>    
<span class="br0">&#125;</span></pre></div></p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;viewdata</span> 
  <span class="re0">regionId</span>=<span class="st0">&quot;int&quot;</span> 
  <span class="re0">figures</span>=<span class="st0">&quot;ValueHolder[[RegionSales]]&quot;</span> 
  <span class="re0">salesChanged</span>=<span class="st0">&quot;ICacheSignal&quot;</span><span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;cache</span> <span class="re0">key</span>=<span class="st0">&quot;regionId&quot;</span> <span class="re0">signal</span>=<span class="st0">&quot;salesChanged&quot;</span><span class="re2">&gt;</span></span>
  All of the ${figures.Value.Stuff} shown here
<span class="sc3"><span class="re1">&lt;/cache<span class="re2">&gt;</span></span></span></pre></div></p>

<p>The ICacheSignal contains only a single event named Changed, and you may implement that interface in any way you would like. For example you can use a single instance of that object for your entire database, or you could have a distinct instance for each piece of data you want to expire individually.</p>

<p>There is also a CacheSignal class you may use which implements ICacheSignal. It has a public method named FireChanged you may call at any time to expire all cached output which used that instance as a signal.</p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw1">public</span> <span class="kw4">class</span> RegionSalesWatcher
<span class="br0">&#123;</span>
  <span class="kw1">static</span> CacheSignal _allDataSignal <span class="sy0">=</span> <span class="kw3">new</span> CacheSignal<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
  ICacheSignal GetSignalForRegion<span class="br0">&#40;</span><span class="kw4">int</span> regionId<span class="br0">&#41;</span>
  <span class="br0">&#123;</span>
    <span class="kw1">return</span> _allDataSignal<span class="sy0">;</span>
  <span class="br0">&#125;</span>
&nbsp;
  <span class="kw1">public</span> <span class="kw1">static</span> <span class="kw1">void</span> AppStarted<span class="br0">&#40;</span><span class="br0">&#41;</span>
  <span class="br0">&#123;</span>
    <span class="co1">//obvious pseudo-code</span>
    <span class="kw4">var</span> conn <span class="sy0">=</span> opendatabase<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    conn.<span class="me1">selecttableswithnotification</span><span class="br0">&#40;</span>OnTablesChanged<span class="br0">&#41;</span><span class="sy0">;</span>
  <span class="br0">&#125;</span>
&nbsp;
  <span class="kw1">static</span> <span class="kw1">void</span> OnTablesChanged<span class="br0">&#40;</span><span class="br0">&#41;</span>
  <span class="br0">&#123;</span>
    _allDataSignal.<span class="me1">FireChanged</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
  <span class="br0">&#125;</span> 
<span class="br0">&#125;</span></pre></div></p>

<p>Yet way of using CacheSignal would be as a base class. In this case you would override the Enabled and Disabled methods to build up and tear down the change watching mechanism, and call the base FireChanged when a change occurs.</p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw1">public</span> <span class="kw4">class</span> FileWatcherSignal <span class="sy0">:</span> ChangeSignal
<span class="br0">&#123;</span>
  <span class="kw4">string</span> _path<span class="sy0">;</span>
  <span class="kw1">public</span> FileWatcherSignal<span class="br0">&#40;</span><span class="kw4">string</span> path<span class="br0">&#41;</span>
  <span class="br0">&#123;</span>
    _path <span class="sy0">=</span> path<span class="sy0">;</span>
  <span class="br0">&#125;</span>
&nbsp;
  <span class="kw1">protected</span> <span class="kw1">override</span> <span class="kw1">void</span> Enable<span class="br0">&#40;</span><span class="br0">&#41;</span>
  <span class="br0">&#123;</span> 
     pseudo_code_start_file_watcher<span class="br0">&#40;</span>FileWatcher_ChangedEventHandler<span class="br0">&#41;</span><span class="sy0">;</span>
  <span class="br0">&#125;</span>
&nbsp;
  <span class="kw1">protected</span> <span class="kw1">override</span> <span class="kw1">void</span> Disable<span class="br0">&#40;</span><span class="br0">&#41;</span>
  <span class="br0">&#123;</span> 
     pseudo_code_stop_file_watcher<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
  <span class="br0">&#125;</span>
&nbsp;
  <span class="kw1">void</span> FileWatcher_ChangedEventHandler<span class="br0">&#40;</span><span class="br0">&#41;</span>
  <span class="br0">&#123;</span>
    FireChanged<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
  <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></p>

<p>Although Spark provides support for signaling cache expiration, and the ICacheSignal interface and CacheSignal class, there are no built-in implementations of file or database change notifiers. The assumption is that databases and their access libraries are so varied there's a vanishingly small change canned implementations would be useful.</p>

<p>Or how does this sound... Send me a patch and I'll add them. :)</p>

<h3 id="Usingcachewithxmlattributes">Using cache with xml attributes</h3>

<p>The <code>&lt;cache&gt;</code> element can be implied by adding certain attributes to other elements.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;div</span> cache.<span class="re0">key</span>=<span class="st0">&quot;employeeId&quot;</span> 
     cache.<span class="re0">expires</span>=<span class="st0">&quot;TimeSpan.FromMinutes(20)&quot;</span> 
     cache.<span class="re0">signal</span>=<span class="st0">&quot;MyApp.Signals.Employees&quot;</span><span class="re2">&gt;</span></span>
  This div element is cached.
<span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span></pre></div></p>

<p>The attribute <code>cache="xxx"</code> is an alias for <code>cache.key="xxx"</code></p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;div</span> <span class="re0">cache</span>=<span class="st0">&quot;employeeId&quot;</span> cache.<span class="re0">expires</span>=<span class="st0">&quot;180&quot;</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>This has a 3 minute sliding expiration per employee id<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>${employeeId}<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span></pre></div></p>
  </div>
<div id="node-11" class="section-2">
  <h1 class="book-heading">Precompiling Views</h1>
  <p><div class="toc">
<div class="toc-title">Table of Contents [<a href="#" class="toc-toggle">hide</a>]</div>
<div class="toc-list">
<ul>

<ul>

<ul>
	<li><a href="#PrecompilingonstartupwiththeAspNetMvcSparkViewFactory">Precompiling on-startup with the Asp.Net Mvc SparkViewFactory</a></li>
	<li><a href="#PrecompilingonstartupwiththeCastleMonoRailSparkViewFactory">Precompiling on-startup with the Castle MonoRail SparkViewFactory</a></li>
	<li><a href="#PrecompilingonstartupwiththelowlevelSparkViewEngine">Precompiling on-startup with the low-level SparkViewEngine</a></li>
	<li><a href="#Usingprecompilationinaunittest">Using precompilation in a unit test</a></li>
	<li><a href="#Precompilingbindeployableassemblywithinstallutilandwithapostbuildstep">Precompiling bin-deployable assembly with installutil and with a post-build step</a></li>
	<li><a href="#Loadingadeployedprecompiledassembly">Loading a deployed precompiled assembly</a></li>
	<li><a href="#Configuringbatchdescriptors">Configuring batch descriptors</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div></p>

<p>You can create a precompiled assembly with view classes at a high level with the a batch descriptor and a SparkViewFactory, or at a low level with an array of view descriptors and a SparkViewEngine.</p>

<p>If you provide a high-level batch descriptor to the asp.net mvc or castle monorail SparkViewFactory it will be converted into an array of descriptors based on which view files exist. Those will then be passed to the SparkViewEngine.</p>

<h3 id="PrecompilingonstartupwiththeAspNetMvcSparkViewFactory">Precompiling on-startup with the Asp.Net Mvc SparkViewFactory</h3>

<p><div class="geshifilter"><pre class="geshifilter-csharp">        <span class="kw1">public</span> <span class="kw1">static</span> <span class="kw1">void</span> PrecompileViews<span class="br0">&#40;</span>ControllerBuilder builder<span class="br0">&#41;</span>
        <span class="br0">&#123;</span>
            <span class="kw4">var</span> controllerFactory <span class="sy0">=</span> <span class="br0">&#40;</span>SparkControllerFactory<span class="br0">&#41;</span>builder.<span class="me1">GetControllerFactory</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="kw4">var</span> viewFactory <span class="sy0">=</span> <span class="kw3">new</span> SparkViewFactory<span class="br0">&#40;</span>controllerFactory.<span class="me1">Settings</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="kw4">var</span> batch <span class="sy0">=</span> <span class="kw3">new</span> SparkBatchDescriptor<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            batch
                .<span class="kw1">For</span><span class="sy0">&lt;</span>HomeController<span class="sy0">&gt;</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
                .<span class="kw1">For</span><span class="sy0">&lt;</span>ProductsController<span class="sy0">&gt;</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            viewFactory.<span class="me1">Precompile</span><span class="br0">&#40;</span>batch<span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span></pre></div></p>

<p>A static method like this would be called from Global Application_Start. The tricky part is getting your hands on the instance of the view factory.</p>

<h3 id="PrecompilingonstartupwiththeCastleMonoRailSparkViewFactory">Precompiling on-startup with the Castle MonoRail SparkViewFactory</h3>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="co1">//todo - about the same. just need sample code</span></pre></div></p>

<h3 id="PrecompilingonstartupwiththelowlevelSparkViewEngine">Precompiling on-startup with the low-level SparkViewEngine</h3>

<p>If you create an instance of the SparkViewEngine you can call BatchCompilation directly. It takes the name of the target assembly, which should have the .dll extension, and a list of SparkViewDescriptor which have been filled in. The SparkViewEngine will need to have the ViewFolder property set.</p>

<p><div class="geshifilter"><pre class="geshifilter-csharp">            <span class="kw4">var</span> engine <span class="sy0">=</span> <span class="kw3">new</span> SparkViewEngine<span class="br0">&#40;</span>settings<span class="br0">&#41;</span>
                             <span class="br0">&#123;</span>
                                 ViewFolder <span class="sy0">=</span> <span class="kw3">new</span> FileSystemViewFolder<span class="br0">&#40;</span>viewsLocation<span class="br0">&#41;</span>
                             <span class="br0">&#125;</span><span class="sy0">;</span>
&nbsp;
            engine.<span class="me1">BatchCompilation</span><span class="br0">&#40;</span>targetPath, Global.<span class="me1">AllKnownDescriptors</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre></div></p>

<h3 id="Usingprecompilationinaunittest">Using precompilation in a unit test</h3>

<p>With Asp.Net Mvc the view factory is fairly easy to create when you need it. The tricky part can be making sure the path to the views folder is correct. You could pass in settings or assume that the spark section in the app.config in your test project is correct.</p>

<p><div class="geshifilter"><pre class="geshifilter-csharp">            <span class="kw4">var</span> viewFactory <span class="sy0">=</span> <span class="kw3">new</span> SparkViewFactory<span class="br0">&#40;</span>settings<span class="br0">&#41;</span>
                                  <span class="br0">&#123;</span>
                                      ViewSourceLoader <span class="sy0">=</span> <span class="kw3">new</span> FileSystemViewSourceLoader<span class="br0">&#40;</span><span class="st0">@&quot;..\..\..\NorthwindDemo\Views&quot;</span><span class="br0">&#41;</span>
                                  <span class="br0">&#125;</span><span class="sy0">;</span>
&nbsp;
            <span class="kw4">var</span> batch <span class="sy0">=</span> <span class="kw3">new</span> SparkBatchDescriptor<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            batch.<span class="kw1">For</span><span class="sy0">&lt;</span>ProductsController<span class="sy0">&gt;</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            viewFactory.<span class="me1">Precompile</span><span class="br0">&#40;</span>batch<span class="br0">&#41;</span><span class="sy0">;</span></pre></div></p>

<p>The return value of Precompile and BatchCompilation is the resulting loaded Assembly. You could continue to make assertions about the number of types in the file.</p>

<h3 id="Precompilingbindeployableassemblywithinstallutilandwithapostbuildstep">Precompiling bin-deployable assembly with installutil and with a post-build step</h3>

<p>This one is probably the coolest one. Especially if you're developing a web app to deploy to a medium trust shared environment. You can find some examples of this in the Samples\AspNetMvc\PrecompiledViews project and Samples\DirectUsage\MediumTrustHosting project.</p>

<p>First: Add the following to the web.config. This will cause an exception to be thrown if your web app ever tries to compile a view at runtime, which will help avoid a situation where you work in development (because the view will generate on the fly) but not in production.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml">  <span class="sc3"><span class="re1">&lt;system</span>.web<span class="re2">&gt;</span></span>
    <span class="sc3"><span class="re1">&lt;trust</span> <span class="re0">level</span>=<span class="st0">&quot;Medium&quot;</span> <span class="re2">/&gt;</span></span>
    ...</pre></div></p>

<p>Second: Add a new Installer Class item to your web project.  It will have a grey designer surface. From the toolbox drag a new instance of either the MvcContrib.SparkViewEngine.Install.PrecompileInstaller or the Castle.MonoRail.Views.Spark.Install.PrecompileInstaller onto this surface. </p>

<p>(If it's not in the toolbox you may need to right-click one of the categories, say "Choose Items...", and Browse... to locate the assembly that contains the tool you want.)</p>

<p>Third: Select the precompileInstaller1 you just added. If you like you can provide a target assembly file name - by default it will add .Views.dll to your web app assembly name. Then choose the events in the properties (yellow lightning) and double-click "DescribeBatch". Provide the implementation, for example:</p>

<p><div class="geshifilter"><pre class="geshifilter-csharp">        <span class="kw1">private</span> <span class="kw1">void</span> precompileInstaller1_DescribeBatch<span class="br0">&#40;</span><span class="kw4">object</span> sender, DescribeBatchEventArgs e<span class="br0">&#41;</span>
        <span class="br0">&#123;</span>
            e.<span class="me1">Batch</span>
                .<span class="kw1">For</span><span class="sy0">&lt;</span>HomeController<span class="sy0">&gt;</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
                .<span class="kw1">For</span><span class="sy0">&lt;</span>HomeController<span class="sy0">&gt;</span><span class="br0">&#40;</span><span class="br0">&#41;</span>.<span class="me1">Layout</span><span class="br0">&#40;</span><span class="st0">&quot;Ajax&quot;</span><span class="br0">&#41;</span>.<span class="me1">Include</span><span class="br0">&#40;</span><span class="st0">&quot;_Notification&quot;</span><span class="br0">&#41;</span>
                .<span class="kw1">For</span><span class="sy0">&lt;</span>AccountController<span class="sy0">&gt;</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span></pre></div></p>

<p>You could also add a static to Global and have this event handler call that static if you don't want to bury information like this in an event on a designer of an installer component. You could also then re-use that function from a unit test that compiles everything also.</p>

<p>Fourth and finally: Right-click the web project, choose properties, and change the Build Events. Add the following Post-build event command line:</p>

<p><div class="geshifilter"><pre class="geshifilter-xml">%systemroot%\Microsoft.NET\Framework\v2.0.50727\installutil &quot;$(TargetPath)&quot;</pre></div></p>

<p>Done! Now every time you hit Build, or F5-Debug/Run, or run unit tests from visual studio you'll automatically generate the precompiled views assembly in the bin directory. Plus, as icing on the cake, if there are any errors that occur in the installer they'll show up in the build output.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml">------ Build started: Project: PrecompiledViews, Configuration: Debug Any CPU ------
PrecompiledViews -&gt; E:\Projects\spark\src\Samples\AspNetMvc\PrecompiledViews\bin\PrecompiledViews.dll
%systemroot%\Microsoft.NET\Framework\v2.0.50727\installutil &quot;E:\Projects\spark\src\Samples\AspNetMvc\PrecompiledViews\bin\PrecompiledViews.dll&quot;
Microsoft (R) .NET Framework Installation utility Version 2.0.50727.1433
Copyright (c) Microsoft Corporation.  All rights reserved.
...etc...
An exception occurred during the Install phase.
Spark.Compiler.CompilerException: Dynamic view compilation failed.
generated.cs(20,22): error CS0103: The name 'hi' does not exist in the current context</pre></div></p>

<h3 id="Loadingadeployedprecompiledassembly">Loading a deployed precompiled assembly</h3>

<p>When the app loads, usually in Global.Application_Start, you can load an existing precompiled view assembly instead of generating one. You would need to call SparkViewEngine's LoadCompilation(Assembly precompiled) method. It will enumerate all of the public types in the assembly to recreate and cache the appropriate SparkViewDescriptors. The array of descriptors which were loaded are returned.</p>

<p><div class="geshifilter"><pre class="geshifilter-csharp">        <span class="kw1">public</span> <span class="kw1">static</span> <span class="kw1">void</span> LoadPrecompiledViews<span class="br0">&#40;</span>SparkViewFactory factory<span class="br0">&#41;</span>
        <span class="br0">&#123;</span>
            factory.<span class="me1">Engine</span>.<span class="me1">LoadBatchCompilation</span><span class="br0">&#40;</span>Assembly.<span class="me1">Load</span><span class="br0">&#40;</span><span class="st0">&quot;MyWebApp.Views.dll&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span></pre></div></p>

<p>As always, the tricky part can be getting your hands on an instance of the SparkViewFactory.</p>

<p>There is no dynamic recompilation of classes that are loaded in this way and changes to the spark files will have no effect. However the files must be available on disk at runtime. Sorry about that - but the different frameworks still needs to test for the view files' existence to know what view descriptor it should instantiate.</p>

<h3 id="Configuringbatchdescriptors">Configuring batch descriptors</h3>

<p>The batch descriptor contains multiple entries and is built with a fluent interface. The target assembly name can be provided on the constructor, otherwise the assembly will be named after a guid and go to the temporary asp.net files directory.</p>

<p>Each call to  .For&lt;YourController&gt;() starts a new rule entry. Within a rule you can call Layout, Include, and Exclude multiple times. Include and Exclude can have patterns that end with *. If the pattern ends with * it won't find things in "Shared". The other special case is the single character "*" which matches anything that doesn't start with an underscore. </p>

<p><div class="geshifilter"><pre class="geshifilter-csharp">batch
  .<span class="kw1">For</span><span class="sy0">&lt;</span>HomeController<span class="sy0">&gt;</span>
  .<span class="kw1">For</span><span class="sy0">&lt;</span>HomeController<span class="sy0">&gt;</span>.<span class="me1">Layout</span><span class="br0">&#40;</span><span class="st0">&quot;ajax&quot;</span><span class="br0">&#41;</span>.<span class="me1">Include</span><span class="br0">&#40;</span><span class="st0">&quot;_*&quot;</span><span class="br0">&#41;</span>
  .<span class="kw1">For</span><span class="sy0">&lt;</span>ProductsController<span class="sy0">&gt;</span>.<span class="me1">Include</span><span class="br0">&#40;</span><span class="st0">&quot;Index&quot;</span><span class="br0">&#41;</span>.<span class="me1">Include</span><span class="br0">&#40;</span><span class="st0">&quot;List&quot;</span><span class="br0">&#41;</span>.<span class="me1">Include</span><span class="br0">&#40;</span><span class="st0">&quot;Detail&quot;</span><span class="br0">&#41;</span>
  .<span class="kw1">For</span><span class="sy0">&lt;</span>AccountController<span class="sy0">&gt;</span>.<span class="me1">Include</span><span class="br0">&#40;</span><span class="st0">&quot;*&quot;</span><span class="br0">&#41;</span>.<span class="me1">Exclude</span><span class="br0">&#40;</span><span class="st0">&quot;TestMessage&quot;</span><span class="br0">&#41;</span>.<span class="me1">Exclude</span><span class="br0">&#40;</span><span class="st0">&quot;Blah&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre></div></p>

<p>If Include is not called for a rule the default is to include all views that don't start with a "_". If Layout is not called the default is to use the layout that would be used automatically appropriate for the framework in question. If you call .Layout multiple times it'll generate a class for each combination of layout and view. That's if you want to precompile several themes where the controller will specify the layout at runtime.</p>

<p>A call to layout can take an array of strings. This is <em>not</em> the same as calling Layout multiple times - rather it's to support MonoRail's ability to organize the layout into several layers.</p>
  </div>
<div id="node-14" class="section-2">
  <h1 class="book-heading">View Locations</h1>
  <div class="toc">
<div class="toc-title">Table of Contents [<a href="#" class="toc-toggle">hide</a>]</div>
<div class="toc-list">
<ul>

<ul>
	<li><a href="#Sparkfilepatterns">Spark file patterns</a></li>
	<li><a href="#Extendingfilepatternswithdescriptorfilters">Extending file patterns with descriptor filters</a>
<ul>
	<li><a href="#AreaDescriptorFilter">AreaDescriptorFilter</a></li>
	<li><a href="#ThemeDescriptorFilter">ThemeDescriptorFilter</a></li>
	<li><a href="#LanguageDescriptorFilter">LanguageDescriptorFilter</a></li>
</ul>
</li>
	<li><a href="#CustomIDescriptorFilterimplementations">Custom IDescriptorFilter implementations</a></li>
	<li><a href="#UnderstandingIViewFolderandIViewFile">Understanding IViewFolder and IViewFile</a></li>
	<li><a href="#Defaultviewfolderlocations">Default view folder locations</a></li>
	<li><a href="#Addingaviewfoldertoconfig">Adding a view folder to config</a></li>
	<li><a href="#Understandingthesubfolderparameter">Understanding the subfolder parameter</a></li>
</ul>
</li>
</ul>
</div>
</div>

<h2 id="Sparkfilepatterns">Spark file patterns</h2>

<p>Spark will locate files using a very conventional pattern. These patterns will not change no matter which view folders are configured.</p>

<p>For controller views, the name of the controller and the name of the view are combined, like <code>home\index.spark</code>. If that file does not exist the name of the view is looked for in the Shared folder, like <code>shared\index.spark</code>.</p>

<p>For master layout templates, the name of the master will looked for in the Layouts folder, like <code>layouts\application.spark</code>. If that file does not exist it too will be looked for in the Shared folder, like <code>shared\application.spark</code>.</p>

<p>These patters will be looked for <em>inside</em> the view folder implementations. The view folders will never alter that part of the Spark file pattern, and the patterns won't affect the location of the view folders. This is very different from the behavior of the WebForms view engine which allows you to provide an array of customized virtual paths.</p>

<p>Sorry, but it was simply impossible to give the view engine full control of the entire path and remain compatible with the different frameworks and existing usage. The customized virtual paths are also incompatible with some of the specialized view folder sources.</p>

<h2 id="Extendingfilepatternswithdescriptorfilters">Extending file patterns with descriptor filters</h2>

<p>This is an ASP.NET MVC specific feature. In MonoRail the framework locates the view files and the paths are provided explicitly.</p>

<p>The SparkViewFactory uses a IDescriptorBuilder service to turn master, controller, and view names into a SparkViewDescriptor. The DefaultDescriptorBuilder provides a mechanism to add any number of IDescriptorFilter implementations to modify the potential locations of a view using information from the current request context.</p>

<p>There are three build-in implementations of IDescriptorFilter: AreaDescriptorFilter, LanguageDescriptorFilter, and ThemeDescriptorFilter. All three are optional, but the AreaDescriptorFilter is added by default. The other two require the web application to provide the mechanism that identifies a theme or language for a request.</p>

<p>Note: this descriptor filters only alter the search paths for views, layouts, and asp.net partial views. It does not change the search paths for <code>_filename.spark</code> partial files.</p>

<p>Here is example of adding a language filter. The LanguageDecriptorFilter is an abstract class, so you either need to inherit and implement or use the static method For which takes a lambda expression or method reference.</p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw1">public</span> <span class="kw1">static</span> <span class="kw1">void</span> RegisterViewEngine<span class="br0">&#40;</span>ICollection<span class="sy0">&lt;</span>IViewEngine<span class="sy0">&gt;</span> engines<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    <span class="kw4">var</span> services <span class="sy0">=</span> SparkEngineStarter.<span class="me1">CreateContainer</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    services.<span class="me1">AddFilter</span><span class="br0">&#40;</span>LanguageDescriptorFilter.<span class="kw1">For</span><span class="br0">&#40;</span>GetSessionCulture<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    SparkEngineStarter.<span class="me1">RegisterViewEngine</span><span class="br0">&#40;</span>services<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
<span class="kw1">public</span> <span class="kw1">static</span> <span class="kw4">string</span> GetSessionCulture<span class="br0">&#40;</span>ControllerContext controllerContext<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    <span class="kw1">return</span> Convert.<span class="me1">ToString</span><span class="br0">&#40;</span>controllerContext.<span class="me1">HttpContext</span>.<span class="me1">Session</span><span class="br0">&#91;</span><span class="st0">&quot;culture&quot;</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></div></p>

<h3 id="AreaDescriptorFilter">AreaDescriptorFilter</h3>

<p>The area filter by default detects an {area} RouteData.Value. It is added as leading folder.</p>

<p>For example, with Area:Sales, Controller:Foo, and View:Bar the locations:</p>

<ul>
<li>Foo/Bar.spark</li>
<li>Shared/Bar.spark</li>
</ul>

<p>become:</p>

<ul>
<li>Sales/Foo/Bar.spark</li>
<li>Sales/Shared/Bar.spark</li>
<li>Foo/Bar.spark</li>
<li>Shared/Bar.spark</li>
</ul>

<h3 id="ThemeDescriptorFilter">ThemeDescriptorFilter</h3>

<p>The theme filter requires a lambda expression or method reference at a minimum (see above). The theme could be stored anywhere in the request context like a session variable, cookie, or user profile settings.</p>

<p>The filter will extend the potential locations for views by prefixing a Themes folder and the name of the theme to the potential locations. For example, with Theme:CleanBlue, Controller:Foo, and View:Bar the potential locations:</p>

<ul>
<li>Foo/Bar.spark</li>
<li>Shared/Bar.spark</li>
</ul>

<p>become:</p>

<ul>
<li>Themes/CleanBlue/Foo/Bar.spark</li>
<li>Themes/CleanBlue/Sales/Shared/Bar.spark</li>
<li>Foo/Bar.spark</li>
<li>Shared/Bar.spark</li>
</ul>

<h3 id="LanguageDescriptorFilter">LanguageDescriptorFilter</h3>

<p>Like the theme filter, the language descriptor filter requires a lambda expression when it's registered.</p>

<p>This filter operates by inserting the language-locale, and just the language, before the extension on each potential location. For example, with Langauge:en-US, Controller:Foo, and View:Bar the potential locations:</p>

<ul>
<li>Foo/Bar.spark</li>
<li>Shared/Bar.spark</li>
</ul>

<p>become:</p>

<ul>
<li>Foo/Bar.en-US.spark</li>
<li>Foo/Bar.en.spark</li>
<li>Foo/Bar.spark</li>
<li>Shared/Bar.en-US.spark</li>
<li>Shared/Bar.en.spark</li>
<li>Shared/Bar.spark</li>
</ul>

<h2 id="CustomIDescriptorFilterimplementations">Custom IDescriptorFilter implementations</h2>

<p>It should be very simple to implement a custom descriptor filter. The only two methods are <code>ExtraParameters</code>, which is called frequently to extract significant values for the filter from the current context, and <code>PotentialLocations</code>, which is called on a cache-miss to extend the list of paths where a given view template may exist.</p>

<p>As an example, this is the implementation of the AreaDescriptorFilter.</p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw1">public</span> <span class="kw4">class</span> AreaDescriptorFilter <span class="sy0">:</span> DescriptorFilterBase
<span class="br0">&#123;</span>
    <span class="kw1">public</span> <span class="kw1">override</span> <span class="kw1">void</span> ExtraParameters<span class="br0">&#40;</span>
        ControllerContext context, 
        IDictionary<span class="sy0">&lt;</span><span class="kw4">string</span>, <span class="kw4">object</span><span class="sy0">&gt;</span> extra<span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        <span class="kw4">object</span> value<span class="sy0">;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span>context.<span class="me1">RouteData</span>.<span class="me1">Values</span>.<span class="me1">TryGetValue</span><span class="br0">&#40;</span><span class="st0">&quot;area&quot;</span>, <span class="kw1">out</span> value<span class="br0">&#41;</span><span class="br0">&#41;</span>
            extra<span class="br0">&#91;</span><span class="st0">&quot;area&quot;</span><span class="br0">&#93;</span> <span class="sy0">=</span> value<span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    <span class="kw1">public</span> <span class="kw1">override</span> IEnumerable<span class="sy0">&lt;</span><span class="kw4">string</span><span class="sy0">&gt;</span> PotentialLocations<span class="br0">&#40;</span>
        IEnumerable<span class="sy0">&lt;</span><span class="kw4">string</span><span class="sy0">&gt;</span> locations, 
        IDictionary<span class="sy0">&lt;</span><span class="kw4">string</span>, <span class="kw4">object</span><span class="sy0">&gt;</span> extra<span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        <span class="kw4">string</span> areaName<span class="sy0">;</span>
        <span class="kw1">return</span> TryGetString<span class="br0">&#40;</span>extra, <span class="st0">&quot;area&quot;</span>, <span class="kw1">out</span> areaName<span class="br0">&#41;</span>
                   <span class="sy0">?</span> locations.<span class="me1">Select</span><span class="br0">&#40;</span>x <span class="sy0">=&gt;</span> Path.<span class="me1">Combine</span><span class="br0">&#40;</span>areaName, x<span class="br0">&#41;</span><span class="br0">&#41;</span>.<span class="me1">Concat</span><span class="br0">&#40;</span>locations<span class="br0">&#41;</span>
                   <span class="sy0">:</span> locations<span class="sy0">;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></p>

<h2 id="UnderstandingIViewFolderandIViewFile">Understanding IViewFolder and IViewFile</h2>

<p>The Spark library declares two interfaces which provide the ability to locate view files and load their contents. There are very few methods and several implementations of typical view locations are provided, so in most cases the most you will need to do is provide additional configuration.</p>

<h2 id="Defaultviewfolderlocations">Default view folder locations</h2>

<p>In a Castle MonoRail application the configured IViewSourceLoader is used by the default IViewFolder implementation. The root location of the default IViewSourceLoader is <code>~/Views</code> and can be changed with the <code>monorail/viewEngines/@viewPathRoot</code> configuration attribute.</p>

<p>In an Asp.Net MVC applications a view folder based on hosting environment's VirtualPathProvider is used. The root location within this will be <code>~/Views</code>.</p>

<p>The behavior of those abstractions can be controlled in ways that aren't documented here; custom VirtualPathProviders is a large topic all on it's own. Whatever you do to the framework to alter how files are loaded should work with Spark as expected.</p>

<p>What is documented on this page is how to bring in additional IViewFolder implementations to extend the way spark files can be located.</p>

<h2 id="Addingaviewfoldertoconfig">Adding a view folder to config</h2>

<p>The <code>&lt;spark&gt;</code> config section accepts a <code>&lt;views&gt;</code> element which can be used to add additional view folder locations.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;spark<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;views<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;add</span> <span class="re0">name</span>=<span class="st0">&quot;{any-unique-name}&quot;</span> 
        <span class="re0">folderType</span>=<span class="st0">&quot;FileSystem|EmbeddedResource|VirtualPathProvider|Custom&quot;</span>
        <span class="re0">type</span>=<span class="st0">&quot;{name, assembly of IViewFolder type}&quot;</span>
        <span class="re0">constuctor-param-names</span>=<span class="st0">&quot;values&quot;</span>
        <span class="re0">subfolder</span>=<span class="st0">&quot;{optional subfolder to target}&quot;</span><span class="re2">/&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;/views<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/spark<span class="re2">&gt;</span></span></span></pre></div></p>

<p>For example:
<div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;spark<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;views<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;add</span> <span class="re0">name</span>=<span class="st0">&quot;stuff&quot;</span> <span class="re0">folderType</span>=<span class="st0">&quot;EmbeddedResource&quot;</span> <span class="re0">assembly</span>=<span class="st0">&quot;MyExtraStuff&quot;</span> <span class="re0">resourcePath</span>=<span class="st0">&quot;MyExtraStuff.Views&quot;</span><span class="re2">/&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;/views<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/spark<span class="re2">&gt;</span></span></span></pre></div></p>

<h2 id="Understandingthesubfolderparameter">Understanding the subfolder parameter</h2>

<p>The subfolder parameter will make the contents for a view folder appear at a specific location in the logical views directory. In other words you're adding files, but you're adding them at a subdirectory.</p>

<p>For example if you create a <code>~/Masters</code> directory in your web app you could expose it in place with the following:
<div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;spark<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;views<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;add</span> <span class="re0">name</span>=<span class="st0">&quot;morestuff&quot;</span> <span class="re0">folderType</span>=<span class="st0">&quot;VirtualPathProvider&quot;</span> <span class="re0">subfolder</span>=<span class="st0">&quot;layouts&quot;</span> <span class="re0">virtualBaseDir</span>=<span class="st0">&quot;~/Masters&quot;</span><span class="re2">/&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;/views<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/spark<span class="re2">&gt;</span></span></span></pre></div></p>

<p>Any path can be the target for adding additional files. If no subfolder is provided the contents are added at the root.</p>
  </div>
<div id="node-41" class="section-2">
  <h1 class="book-heading">Visual Basic</h1>
  <div class="toc">
<div class="toc-title">Table of Contents [<a href="#" class="toc-toggle">hide</a>]</div>
<div class="toc-list">
<ul>

<ul>

<ul>
	<li><a href="#Creatinganewproject">Creating a new project</a></li>
	<li><a href="#Addingviews">Adding views</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<h3 id="Creatinganewproject">Creating a new project</h3>

<p>Assuming you have a Visual Basic ASP.NET MVC web application there are very few things you need to enable Spark. In the end it's very similar to the CSharp implementation.</p>

<p>First, add references to the following assemblies:</p>

<ul>
<li>Spark.dll</li>
<li>Spark.Web.Mvc.dll</li>
</ul>

<p>Then add the following minimal configuration to change Spark's default target language to Visual Basic:</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;configuration<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;configSections<span class="re2">&gt;</span></span></span>
    ...
    <span class="sc3"><span class="re1">&lt;section</span> <span class="re0">name</span>=<span class="st0">&quot;spark&quot;</span> <span class="re0">type</span>=<span class="st0">&quot;Spark.Configuration.SparkSectionHandler, Spark&quot;</span><span class="re2">/&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;/configSections<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;spark<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;compilation</span> <span class="re0">defaultLanguage</span>=<span class="st0">&quot;VisualBasic&quot;</span><span class="re2">/&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;/spark<span class="re2">&gt;</span></span></span>
  ...
<span class="sc3"><span class="re1">&lt;/configuration<span class="re2">&gt;</span></span></span></pre></div></p>

<p>You'll also want to ensure the <code>&lt;system.codedom&gt;</code> configuration contains a definition of visualbasic which targets the v3.5 framework or higher.</p>

<p>Finally add the following to your Global.asax file:</p>

<p><div class="geshifilter"><pre class="geshifilter-xml">    Shared Sub RegisterViewEngines(ByVal engines As ViewEngineCollection)
        SparkEngineStarter.RegisterViewEngine(engines)
    End Sub
&nbsp;
    Sub Application_Start()
        ....
        RegisterViewEngines(ViewEngines.Engines)
    End Sub</pre></div></p>

<h3 id="Addingviews">Adding views</h3>

<p>At this point everything about Spark works exactly as it does normally with the exception that the CLR syntax used is Visual Basic. Another place to check out VB syntax in Spark is located at <span class="geshifilter"><code class="geshifilter-xml">Samples\AspNetMvc\VisualBasicViews</code></span>.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml">#' this is a comment
&nbsp;
<span class="sc3"><span class="coMULTI">&lt;!-- Dim x = 4 + 5 --&gt;</span></span>
<span class="sc3"><span class="re1">&lt;var</span> <span class="re0">x</span>=<span class="st0">&quot;4 + 5&quot;</span><span class="re2">/&gt;</span></span>
&nbsp;
<span class="sc3"><span class="coMULTI">&lt;!-- Dim xx As Invoice = Nothing --&gt;</span></span>
<span class="sc3"><span class="re1">&lt;var</span> <span class="re0">xx</span>=<span class="st0">&quot;Nothing&quot;</span> <span class="re0">type</span>=<span class="st0">&quot;Invoice&quot;</span> <span class="re2">/&gt;</span></span>
&nbsp;
<span class="sc3"><span class="coMULTI">&lt;!-- Note: single = used instead of == --&gt;</span></span>
<span class="sc3"><span class="re1">&lt;test</span> <span class="re0">if</span>=<span class="st0">&quot;x = 9&quot;</span><span class="re2">&gt;</span></span>
&nbsp;
  <span class="sc3"><span class="coMULTI">&lt;!-- Note: VisualBasic does not require 'var' in foreach loop
  &lt;!-- For Each prod in Products --&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;for</span> <span class="re0">each</span>=<span class="st0">&quot;prod in Products&quot;</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;/for<span class="re2">&gt;</span></span></span>
&nbsp;
  <span class="sc3"><span class="coMULTI">&lt;!-- and you can provide type in the loop with optional 'As' --&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;for</span> <span class="re0">each</span>=<span class="st0">&quot;p As Product in Products&quot;</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;/for<span class="re2">&gt;</span></span></span>
&nbsp;
<span class="sc3"><span class="re1">&lt;/test<span class="re2">&gt;</span></span></span>
&nbsp;
<span class="sc3"><span class="coMULTI">&lt;!-- And the rest is about like you'd expect --&gt;</span></span>
#Using Html.BeginForm()
&nbsp;
<span class="sc3"><span class="coMULTI">&lt;!-- although the anonymous object syntax is a bit odd --&gt;</span></span>
&nbsp;
!{Html.ActionLink(&quot;Show Order&quot;, &quot;View&quot;, New With {.id = MyOrderId} ) }
&nbsp;
#End Using</pre></div></p>
  </div>
<div id="node-15" class="section-2">
  <h1 class="book-heading">Iron Python</h1>
  <div class="toc">
<div class="toc-title">Table of Contents [<a href="#" class="toc-toggle">hide</a>]</div>
<div class="toc-list">
<ul>

<ul>

<ul>
	<li><a href="#AboutIronPython">About Iron Python</a></li>
	<li><a href="#Creatinganewproject">Creating a new project</a></li>
	<li><a href="#Addingviews">Adding views</a></li>
	<li><a href="#Variable">Variable</a></li>
	<li><a href="#ViewData">ViewData</a></li>
	<li><a href="#Loopingandconditional">Looping and conditional</a></li>
	<li><a href="#Inlinecode">Inline code</a></li>
	<li><a href="#Invokingmethodsandhelpers">Invoking methods and helpers</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<h3 id="AboutIronPython">About Iron Python</h3>

<p><a href="http://www.codeplex.com/Wiki/View.aspx?ProjectName=IronPython">Iron Python</a> is a dynamic language runtime (DLR) based implementation of Python. Spark scripting is based on assemblies in the <a href="http://www.codeplex.com/IronPython/Release/ProjectReleases.aspx?ReleaseId=17404">2.0 Release Candidate 1</a> binary zip. Other good resources are the <a href="http://docs.python.org/">Python documentation</a> and the <a href="http://www.python.org/">Python site</a> itself.</p>

<p>The support for the DLR is very Asp.Net MVC centric. If there's an interest in expanded Castle MonoRail support, <a href="http://groups.google.com/group/spark-dev">please speak up in the discussion group</a>.</p>

<h3 id="Creatinganewproject">Creating a new project</h3>

<p>A standard Asp.Net MVC web application is always a great starting place. First, add references to the following assemblies:</p>

<ul>
<li>Spark.dll</li>
<li>Spark.Python.dll</li>
<li>Spark.Web.Mvc.dll</li>
<li>Spark.Web.Mvc.Python.dll</li>
</ul>

<p>And the following from the IronPython release which are available in the Spark bin\dependencies folder. If you have problems with the these files from Codeplex try the ones in from the Spark distribution. You have the "works on my machine" guarantee.</p>

<ul>
<li>Microsoft.Scripting.dll</li>
<li>Microsoft.Scripting.Core.dll</li>
<li>Microsoft.Scripting.ExtensionAttribute.dll</li>
<li>IronPython.dll</li>
<li>IronPython.Modules.dll</li>
</ul>

<p>Yeah, I know. It's a lot of assemblies. You're going to love the next part though, adding the Spark view engine to an Asp.Net MVC web application has been simplified.</p>

<p>Add the following to your Global Application_Start method:</p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw1">using</span> <span class="co3">Spark.Web.Mvc.Scripting</span><span class="sy0">;</span>
...
<span class="kw1">protected</span> <span class="kw1">void</span> Application_Start<span class="br0">&#40;</span><span class="kw4">object</span> sender, EventArgs e<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    SparkPythonEngineStarter.<span class="me1">RegisterViewEngine</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></div></p>

<p>This will create a view engine and add it to the engines collection.</p>

<p>The Spark engine starter also has several utility methods for more advanced initialization. You can, for example, provide a settings object from code. You can also use the ISparkServicesContainer to provide specific implementations of different services used by the Spark engine. For example:</p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="co1">// this example avoids adding &lt;spark&gt; to web.config</span>
<span class="kw4">var</span> settings <span class="sy0">=</span> <span class="kw3">new</span> SparkSettings<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="co1">// change settings, like</span>
settings
    .<span class="me1">SetDebug</span><span class="br0">&#40;</span><span class="kw1">true</span><span class="br0">&#41;</span>
    .<span class="me1">SetPageBaseType</span><span class="br0">&#40;</span><span class="kw3">typeof</span><span class="br0">&#40;</span>MyBasePage<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="kw4">var</span> container <span class="sy0">=</span> SparkPythonEngineStarter.<span class="me1">CreateContainer</span><span class="br0">&#40;</span>settings<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="co1">// change services, like</span>
container.<span class="me1">SetServiceBuilder</span><span class="sy0">&lt;</span>IViewActivatorFactory<span class="sy0">&gt;</span><span class="br0">&#40;</span>
    c <span class="sy0">=&gt;</span> <span class="kw3">new</span> MyViewActivatorFactory<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
SparkPythonEngineStarter.<span class="me1">RegisterViewEngine</span><span class="br0">&#40;</span>
    ViewEngines.<span class="me1">Engines</span>, container<span class="br0">&#41;</span><span class="sy0">;</span></pre></div></p>

<h3 id="Addingviews">Adding views</h3>

<p>Spark views for IronPython look and act much like they would for csharp. They have a .spark extension and exist in the normal <code>Views\&lt;controllername&gt;\&lt;viewname&gt;.spark</code> path.</p>

<p>One of the most obvious differences would be the lack of a need to declare <code>&lt;viewdata/&gt;</code>. Other than that it's pretty darn straightforward. You can execute code inline with <code>#statement</code> and output information with <code>${expression}</code> and all of the <code>&lt;content&gt;</code>, <code>&lt;macro&gt;</code>, support for underscored partials, imports, etc. is unchanged.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml">#import clr
<span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>Methods available from the clr module<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;ul<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;li</span> <span class="re0">each</span>=<span class="st0">&quot;x in dir(clr)&quot;</span><span class="re2">&gt;</span></span>${x}<span class="sc3"><span class="re1">&lt;/li<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/ul<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>Methods (and extension methods) available to the normal helpers<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;ul<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;var</span> <span class="re0">underscores</span>=<span class="st0">&quot;'__'&quot;</span><span class="re2">/&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;li</span> <span class="re0">each</span>=<span class="st0">&quot;x in dir(Html)&quot;</span> <span class="re0">if</span>=<span class="st0">&quot;not x.startswith(underscores)&quot;</span><span class="re2">&gt;</span></span>Html.${x}<span class="sc3"><span class="re1">&lt;/li<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;li</span> <span class="re0">each</span>=<span class="st0">&quot;x in dir(Ajax)&quot;</span> <span class="re0">if</span>=<span class="st0">&quot;not x.startswith(underscores)&quot;</span><span class="re2">&gt;</span></span>Ajax.${x}<span class="sc3"><span class="re1">&lt;/li<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;li</span> <span class="re0">each</span>=<span class="st0">&quot;x in dir(Url)&quot;</span> <span class="re0">if</span>=<span class="st0">&quot;not x.startswith(underscores)&quot;</span><span class="re2">&gt;</span></span>Url.${x}<span class="sc3"><span class="re1">&lt;/li<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/ul<span class="re2">&gt;</span></span></span></pre></div></p>

<p>So once you get past the subtle expression differences it's pretty straightforward. I relied very heavily on the Python language documentation figuring out the syntax to use. If you're comfortable with Python, or simply hate declaring your view data and mucking around with strong types and assembly references, using the DLR might be an attractive option.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;html<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;head<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;global</span> <span class="re0">Title</span>=<span class="st0">&quot;'Python View Language Sample'&quot;</span><span class="re2">/&gt;</span></span>
    <span class="sc3"><span class="re1">&lt;title<span class="re2">&gt;</span></span></span>${Title}<span class="sc3"><span class="re1">&lt;/title<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;/head<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;body<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;use:view</span><span class="re2">/&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;/body<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/html<span class="re2">&gt;</span></span></span></pre></div></p>

<p><div class="geshifilter"><pre class="geshifilter-xml">#Title = &quot;Products - &quot; + Title
<span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>There are ${len(products)} products available<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;ul<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;li</span> <span class="re0">each</span>=<span class="st0">&quot;p in products&quot;</span><span class="re2">&gt;</span></span>${Html.ActionLink(p.Name, &quot;Show&quot;)}<span class="sc3"><span class="re1">&lt;/li<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/ul<span class="re2">&gt;</span></span></span></pre></div></p>

<h3 id="Variable">Variable</h3>

<p>Variable scope in Python is very different than in csharp because of the nature of the language itself. The entire view, and the entire master, are both single functions. All of the variables in those two functions are available to all of the views and partial files.</p>

<p>To share variables between view and master, use the global element, like <code>&lt;global title="'Default Title'"/&gt;</code>. Of course <code>&lt;content name="foo"&gt;...&lt;/content&gt;</code> and <code>&lt;use content="foo"/&gt;</code> can also be used to produce and consume material.</p>

<p>Other forms of variable declaration all end up meaning the same thing. <code>&lt;var x="5" hello="'world'"/&gt;</code>, <code>&lt;def x="5" hello="'world'"/&gt;</code>, and <code>&lt;set x="5" hello="'world'"/&gt;</code> are virtually interchangable - just remember to assign a variable before you use it.</p>

<p>Providing a fall-back value with <code>&lt;default x="1" hello="'(your name here)'"/&gt;</code> will work and is very convenient for assigning default values for optional arguments in partials.</p>

<h3 id="ViewData">ViewData</h3>

<p>Viewdata does need to be declared because the contents of the dictionary will appear to be global symbols. Because they have a lower precedence than view class members you may need to use <code>ViewData["name"]</code> syntax to access information that collides with existing members.</p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw1">public</span> ActionResult Index<span class="br0">&#40;</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
  ViewData<span class="br0">&#91;</span><span class="st0">&quot;foo&quot;</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="st0">&quot;bar&quot;</span><span class="sy0">;</span>
  <span class="kw1">return</span> View<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></div></p>

<p><div class="geshifilter"><pre class="geshifilter-xml">## no declaration needed
<span class="sc3"><span class="re1">&lt;p<span class="re2">&gt;</span></span></span>Foo is ${foo}<span class="sc3"><span class="re1">&lt;/p<span class="re2">&gt;</span></span></span></pre></div></p>

<h3 id="Loopingandconditional">Looping and conditional</h3>

<p>Iteration in Python doesn't require a type declaration on the looping variable. Otherwise it's very similar to Spark with csharp.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;for</span> <span class="re0">each</span>=<span class="st0">&quot;c in categories&quot;</span><span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;h3<span class="re2">&gt;</span></span></span>${H(c.Name)}<span class="sc3"><span class="re1">&lt;/h3<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;ul<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;li</span> <span class="re0">each</span>=<span class="st0">&quot;p in c.Products&quot;</span> <span class="re0">class</span>=<span class="st0">&quot;alt?{pIndex%2}&quot;</span><span class="re2">&gt;</span></span>${H(p.Name)}<span class="sc3"><span class="re1">&lt;/li<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;/ul<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/for<span class="re2">&gt;</span></span></span></pre></div></p>

<p>The conditional elements and attributes (test, if, elseif, else) in all their various forms work fine structurally once you take into account language differences. Python will use <code>not</code>, <code>or</code>, and <code>and</code> boolean keywords rather than punctuation operators. It will also infer the value of True for non-default values. So 0, False, and None (or null) all act as false. Which is why the condition <code>?{pIndex%2}</code> above will give you even-odd striping by removing the alt css class as the result of 0 and 1 varies.</p>

<h3 id="Inlinecode">Inline code</h3>

<p>The <code>#statement&lt;newline&gt;</code> format works <em>especially</em> well for adding Python code inline, but bear in mind how significant whitespace will be. The statement following the # character will be written at the correct indentation for the place it appears in scope, but there should only be whitespace between the # and the code if you're intentionally creating something scoped to a previous statement.</p>

<p>One use for that would be declaring a function.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;h3<span class="re2">&gt;</span></span></span>Declaring a function<span class="sc3"><span class="re1">&lt;/h3<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;ul<span class="re2">&gt;</span></span></span>
  #import math
  ## Calculate the n-dimensional hypotenuse
  #def vectorlength(vector):
  #  dt = 0
  #  for d in vector:
  #    dt = dt + d * d
  #  return math.sqrt(dt)
  <span class="sc3"><span class="re1">&lt;li<span class="re2">&gt;</span></span></span>3,4 : ${vectorlength([3,4])}<span class="sc3"><span class="re1">&lt;/li<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;li<span class="re2">&gt;</span></span></span>12,13 : ${vectorlength([12,13])}<span class="sc3"><span class="re1">&lt;/li<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;li<span class="re2">&gt;</span></span></span>0,5,3,2,0,6 : ${vectorlength([0,5,3,2,0,6])}<span class="sc3"><span class="re1">&lt;/li<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/ul<span class="re2">&gt;</span></span></span></pre></div></p>

<p>Note, since # is a comment in python ## can be used in Spark as a code-comment which won't appear in html output.</p>

<h3 id="Invokingmethodsandhelpers">Invoking methods and helpers</h3>

<p>All methods and properties of the base view class are available . If you're writing output explicitly there is a subtle problem with overloaded methods, like Output.Write(...), when the DLR determines which method to invoke. Writing a number for example will throw an exception because the several flavors of integer and floating point are ambiguous from the scripting point of view. Another method OutputWriteAdapter(object value) has been added to the scripting-specific spark view class, and that is the method ${expression} will invoke.</p>

<p>Some helper methods can be particularly tricky. It appears that native IronPython property-bearing reflect with put properties Keys and Values, so they can't be used for helper methods which take an anonymous type as a dictionary. The good news is you can typically call a different overload of the helper method by building the CLR dictionary classes.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;div<span class="re2">&gt;</span></span></span>
  #import clr
  #clr.AddReference(&quot;System.Web.Routing&quot;)
  #from System.Web.Routing import RouteValueDictionary
  #routeData = RouteValueDictionary()
&nbsp;
  #routeData[&quot;id&quot;] = page.CurrentPage - 1
  <span class="sc3"><span class="re1">&lt;a</span> <span class="re0">href</span>=<span class="st0">&quot;${Url.Action(action, controller, routeData)}&quot;</span><span class="re2">&gt;</span></span><span class="sc1">&amp;laquo;</span> Previous<span class="sc3"><span class="re1">&lt;/a<span class="re2">&gt;</span></span></span>
&nbsp;
  <span class="sc3"><span class="re1">&lt;for</span> <span class="re0">each</span>=<span class="st0">&quot;pageIndex in range(1, page.PageCount + 1)&quot;</span><span class="re2">&gt;</span></span>
    #routeData[&quot;id&quot;] = pageIndex
    <span class="sc3"><span class="re1">&lt;a</span> <span class="re0">href</span>=<span class="st0">&quot;${Url.Action(action, controller, routeData)}&quot;</span><span class="re2">&gt;</span></span>${pageIndex}<span class="sc3"><span class="re1">&lt;/a<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;/for<span class="re2">&gt;</span></span></span>
&nbsp;
  #routeData[&quot;id&quot;] = page.CurrentPage + 1
  <span class="sc3"><span class="re1">&lt;a</span> <span class="re0">href</span>=<span class="st0">&quot;${Url.Action(action, controller, routeData)}&quot;</span><span class="re2">&gt;</span></span>Next <span class="sc1">&amp;raquo;</span><span class="sc3"><span class="re1">&lt;/a<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span>
&nbsp;</pre></div></p>
  </div>
<div id="node-16" class="section-2">
  <h1 class="book-heading">Iron Ruby</h1>
  <div class="toc">
<div class="toc-title">Table of Contents [<a href="#" class="toc-toggle">hide</a>]</div>
<div class="toc-list">
<ul>

<ul>

<ul>
	<li><a href="#AboutIronRuby">About Iron Ruby</a></li>
	<li><a href="#Creatinganewproject">Creating a new project</a></li>
	<li><a href="#Addingviews">Adding views</a></li>
	<li><a href="#Invokingmethodsandhelpers">Invoking methods and helpers</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<h3 id="AboutIronRuby">About Iron Ruby</h3>

<p><a href="http://www.ironruby.net/">Iron Ruby</a> is a <a href="http://blogs.msdn.com/hugunin/archive/2007/04/30/a-dynamic-language-runtime-dlr.aspx">dynamic language runtime</a> (DLR) based implementation of <a href="http://www.ruby-lang.org/en/">Ruby</a>. Spark's Ruby integration is based on slightly modified <a href="http://rubyforge.org/scm/?group_id=4359">trunk code</a>. Other good resources are <a href="http://www.ruby-lang.org/en/documentation/">Ruby documentation</a> and <a href="http://www.ruby-doc.org/docs/ProgrammingRuby/">Programming Ruby</a>.</p>

<p>The build of IronRuby used for Spark has had the assemblies <code>Microsoft.Scripting.*</code> assemblies renamed <code>NonStandard.Microsoft.Scripting.*</code>. Those libraries appear to be works in progess and some irreconcilable differences existed in these shared assemblies in the IronPython and IronRuby sources which were available at the time the integration with Spark was done. As those projects evolve the need for two sets of assemblies should disappear.</p>

<p>The support for the DLR is very Asp.Net MVC centric. If there's an interest in expanded Castle MonoRail support, <a href="http://groups.google.com/group/spark-dev">please speak up in the discussion group</a>.</p>

<h3 id="Creatinganewproject">Creating a new project</h3>

<p>A standard Asp.Net MVC web application is always a great starting place. First, add references to the following assemblies:</p>

<ul>
<li>Spark.dll</li>
<li>Spark.Ruby.dll</li>
<li>Spark.Web.Mvc.dll</li>
<li>Spark.Web.Mvc.Ruby.dll</li>
</ul>

<p>And the following from the IronRuby release which are available in the Spark bin\dependencies folder. If you have problems with the these files from RubyForge try the ones in from the Spark distribution. You have the "works on my machine" guarantee.</p>

<ul>
<li>NonStandard.Microsoft.Scripting.dll</li>
<li>NonStandard.Microsoft.Scripting.Core.dll</li>
<li>NonStandard.Microsoft.Scripting.ExtensionAttribute.dll</li>
<li>IronRuby.dll</li>
<li>IronRuby.Library.dll</li>
</ul>

<p>Yeah, I know. It's a lot of assemblies. You're going to love the next part though, adding the Spark view engine to an Asp.Net MVC web application has been simplified.</p>

<p>Add the following to your Global Application_Start method:</p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw1">using</span> <span class="co3">Spark.Web.Mvc.Ruby</span><span class="sy0">;</span>
...
<span class="kw1">protected</span> <span class="kw1">void</span> Application_Start<span class="br0">&#40;</span><span class="kw4">object</span> sender, EventArgs e<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    SparkRubyEngineStarter.<span class="me1">RegisterViewEngine</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></div></p>

<p>This will create a view engine and add it to the engines collection.</p>

<p>The Spark engine starter also has several utility methods for more advanced initialization. You can, for example, provide a settings object from code. You can also use the ISparkServicesContainer to provide specific implementations of different services used by the Spark engine. For example:</p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="co1">// this example avoids adding &lt;spark&gt; to web.config</span>
<span class="kw4">var</span> settings <span class="sy0">=</span> <span class="kw3">new</span> SparkSettings<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="co1">// change settings, like</span>
settings
    .<span class="me1">SetDebug</span><span class="br0">&#40;</span><span class="kw1">true</span><span class="br0">&#41;</span>
    .<span class="me1">SetPageBaseType</span><span class="br0">&#40;</span><span class="kw3">typeof</span><span class="br0">&#40;</span>MyBasePage<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="kw4">var</span> container <span class="sy0">=</span> SparkRubyEngineStarter.<span class="me1">CreateContainer</span><span class="br0">&#40;</span>settings<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="co1">// change services, like</span>
container.<span class="me1">SetServiceBuilder</span><span class="sy0">&lt;</span>IViewActivatorFactory<span class="sy0">&gt;</span><span class="br0">&#40;</span>
    c <span class="sy0">=&gt;</span> <span class="kw3">new</span> MyViewActivatorFactory<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
SparkRubyEngineStarter.<span class="me1">RegisterViewEngine</span><span class="br0">&#40;</span>
    ViewEngines.<span class="me1">Engines</span>, container<span class="br0">&#41;</span><span class="sy0">;</span></pre></div></p>

<h3 id="Addingviews">Adding views</h3>

<p>Spark views for IronRuby look and act much like they would for csharp. They have a .spark extension and exist in the normal <code>Views\&lt;controllername&gt;\&lt;viewname&gt;.spark</code> path.</p>

<p>The syntax of Ruby on Spark is a bit rhtml-like. Spark supports <code>&lt;%= ... %&gt;</code> and <code>&lt;% ...%&gt;</code> in the same way, and the dictionary of ViewData values are added as <code>@name</code> attributes. Of course, just like other Spark variations can also execute code inline with <code>#statement</code> and output information with <code>${expression}</code> and all of the <code>&lt;content&gt;</code>, <code>&lt;macro&gt;</code>, support for underscored partials, imports, etc. is unchanged.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;html<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;head<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;global</span> <span class="re0">title</span>=<span class="st0">&quot;'Python View Language Sample'&quot;</span><span class="re2">/&gt;</span></span>
    <span class="sc3"><span class="re1">&lt;title<span class="re2">&gt;</span></span></span>${@title}<span class="sc3"><span class="re1">&lt;/title<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;/head<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;body<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;use:view</span><span class="re2">/&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;/body<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/html<span class="re2">&gt;</span></span></span></pre></div></p>

<p><div class="geshifilter"><pre class="geshifilter-xml">#@title = &quot;Products - &quot; + @title
<span class="sc3"><span class="re1">&lt;ul<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;li</span> <span class="re0">each</span>=<span class="st0">&quot;p in @products&quot;</span><span class="re2">&gt;</span></span>${html.ActionLink(p.name, &quot;Show&quot;)}<span class="sc3"><span class="re1">&lt;/li<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/ul<span class="re2">&gt;</span></span></span></pre></div></p>

<h3 id="Invokingmethodsandhelpers">Invoking methods and helpers</h3>

<p>All methods and properties of the base view class are available. Ruby naming convention may be in effect, so if a symbol like ViewData isn't resolved try using view_data.</p>

<p>Some helper methods can be particularly tricky. It appears that native IronRuby can't be used for helper methods which take an anonymous type as a dictionary. The good news is you can typically call those helper methods with a CLR dictionary class you can create. The following is a bit of simplified code from the samples\AspNetMvc\IronRubyViews project available in the download.</p>

<p><div class="geshifilter"><pre class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;div<span class="re2">&gt;</span></span></span>
  ## make a clr route dictionary for url.action
  #require 'System.Web.Routing, Version=3.5.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35'
  #routeData = System::Web::Routing::RouteValueDictionary.new
&nbsp;
  ## monkey patch an id setter equivalent to {routeData[&quot;id&quot;] = value}
  #def routeData.id=(value); set_Item('id',value); end
&nbsp;
  #routeData.id = page.CurrentPage - 1
  <span class="sc3"><span class="re1">&lt;a</span> <span class="re0">href</span>=<span class="st0">&quot;${url.action(action, controller, routeData)}&quot;</span><span class="re2">&gt;</span></span><span class="sc1">&amp;laquo;</span> Previous<span class="sc3"><span class="re1">&lt;/a<span class="re2">&gt;</span></span></span>
&nbsp;
  <span class="sc3"><span class="re1">&lt;for</span> <span class="re0">each</span>=<span class="st0">&quot;pageIndex in 1..page.PageCount&quot;</span><span class="re2">&gt;</span></span>
    #routeData.id = pageIndex
    <span class="sc3"><span class="re1">&lt;a</span> <span class="re0">href</span>=<span class="st0">&quot;${url.action(action, controller, routeData)}&quot;</span><span class="re2">&gt;</span></span>${pageIndex}<span class="sc3"><span class="re1">&lt;/a<span class="re2">&gt;</span></span></span>
  <span class="sc3"><span class="re1">&lt;/for<span class="re2">&gt;</span></span></span>
&nbsp;
  #routeData.id = page.CurrentPage + 1
  <span class="sc3"><span class="re1">&lt;a</span> <span class="re0">href</span>=<span class="st0">&quot;${url.action(action, controller, routeData)}&quot;</span><span class="re2">&gt;</span></span>Next <span class="sc1">&amp;raquo;</span><span class="sc3"><span class="re1">&lt;/a<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/div<span class="re2">&gt;</span></span></span>
&nbsp;</pre></div></p>
  </div>
<div id="node-37" class="section-2">
  <h1 class="book-heading">Reference</h1>
  <h2 id="SparkReference">Spark Reference</h2>

<p>Template elements, attributes, and configuration reference information</p>
  <div id="node-38" class="section-3">
  <h1 class="book-heading">Elements</h1>
  <div class="toc">
<div class="toc-title">Table of Contents [<a href="#" class="toc-toggle">hide</a>]</div>
<div class="toc-list">
<ul>

<ul>
	<li><a href="#content">content</a>
<ul>
	<li><a href="#withname">with name=""</a></li>
	<li><a href="#withvarordef">with var="" or def=""</a></li>
	<li><a href="#withset">with set=""</a></li>
</ul>
</li>
	<li><a href="#def">def</a></li>
	<li><a href="#default">default</a>
<ul>
	<li><a href="#withtype">with type=""</a></li>
</ul>
</li>
	<li><a href="#else">else</a>
<ul>
	<li><a href="#withif">with if=""</a></li>
	<li><a href="#emptyelement">empty element</a></li>
</ul>
</li>
	<li><a href="#elseif">elseif</a></li>
	<li><a href="#for">for</a>
<ul>
	<li><a href="#withassignments">with *="" assignments</a></li>
</ul>
</li>
	<li><a href="#global">global</a>
<ul>
	<li><a href="#withtype-1">with type=""</a></li>
</ul>
</li>
	<li><a href="#if">if</a></li>
	<li><a href="#include">include</a></li>
	<li><a href="#macro">macro</a></li>
	<li><a href="#render">render</a>
<ul>
	<li><a href="#withsection">with section=""</a></li>
	<li><a href="#withassignments-1">with *="" assignments</a></li>
	<li><a href="#withfallbackcontent">with fallback content</a></li>
</ul>
</li>
	<li><a href="#renderpartial">render partial=""</a>
<ul>
	<li><a href="#withassignments-2">with *="" assignments</a></li>
</ul>
</li>
	<li><a href="#section">section</a>
<ul>
	<li><a href="#withassignments-3">with *="" assignments</a></li>
</ul>
</li>
	<li><a href="#set">set</a></li>
	<li><a href="#test">test</a></li>
	<li><a href="#useassembly">use assembly=""</a></li>
	<li><a href="#usecontent">use content=""</a>
<ul>
	<li><a href="#withfallbackcontent-1">with fallback content</a></li>
</ul>
</li>
	<li><a href="#usefile">use file=""</a></li>
	<li><a href="#useimport">use import=""</a></li>
	<li><a href="#usemaster">use master=""</a></li>
	<li><a href="#usenamespace">use namespace=""</a></li>
	<li><a href="#var">var</a>
<ul>
	<li><a href="#withtype-2">with type=""</a></li>
</ul>
</li>
	<li><a href="#viewdata">viewdata</a>
<ul>
	<li><a href="#withdefault">with default=""</a></li>
	<li><a href="#withpropertyname">with property name</a></li>
</ul>
</li>
	<li><a href="#viewdatamodel">viewdata model=""</a>
<ul>
	<li><a href="#withpropertyname-1">with property name</a></li>
</ul>
</li>
	<li><a href="#Seealsosourcecode">See also: source code</a></li>
</ul>
</li>
</ul>
</div>
</div>

<hr />

<h2 id="content">content</h2>

<p>Captures output contained within the content element to a text spool or local variable.</p>

<h3 id="withname">with name=""</h3>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;content</span> <span class="re0">name</span>=<span class="st0">&quot;x&quot;</span><span class="re2">&gt;</span></span>anyXml<span class="sc3"><span class="re1">&lt;/content<span class="re2">&gt;</span></span></span></code></span></p>

<p>Spools all output in the content element into a named text writer. The named content can be placed as output later with a <code>&lt;use/&gt;</code> element, or can be accessed directly with the <code>Content["x"]</code> dictionary.</p>

<h3 id="withvarordef">with var="" or def=""</h3>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;content</span> <span class="re0">var</span>=<span class="st0">&quot;x&quot;</span><span class="re2">&gt;</span></span>anyXml<span class="sc3"><span class="re1">&lt;/content<span class="re2">&gt;</span></span></span></code></span></p>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;content</span> <span class="re0">def</span>=<span class="st0">&quot;x&quot;</span><span class="re2">&gt;</span></span>anyXml<span class="sc3"><span class="re1">&lt;/content<span class="re2">&gt;</span></span></span></code></span></p>

<p>Spools all output into a temporary text writer, then assigns the results into a new string local variable named by the var attribute value.</p>

<h3 id="withset">with set=""</h3>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;content</span> <span class="re0">set</span>=<span class="st0">&quot;x&quot;</span><span class="re2">&gt;</span></span>anyXml<span class="sc3"><span class="re1">&lt;/content<span class="re2">&gt;</span></span></span></code></span></p>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;content</span> <span class="re0">set</span>=<span class="st0">&quot;x&quot;</span> <span class="re0">add</span>=<span class="st0">&quot;before|after|replace&quot;</span><span class="re2">&gt;</span></span>anyXml<span class="sc3"><span class="re1">&lt;/content<span class="re2">&gt;</span></span></span></code></span></p>

<p>Spools all output into a temporary text writer, then assigns the results into an existing local variable named by the set attribute value.</p>

<p>If the content element also contains <code>add="after"</code> the capured content will be appended to the end of the variable's existing value. If it contains <code>add="before"</code> the content will be appended to the front of the existing variable value.</p>

<hr />

<h2 id="def">def</h2>

<p>An alias for declaring a local variable, see <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;var</span><span class="re2">/&gt;</span></span></code></span>.</p>

<hr />

<h2 id="default">default</h2>

<p>Declares local variables if a symbol of a given name is not known to be in scope.</p>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;default</span> <span class="re0">x</span>=<span class="st0">&quot;a&quot;</span> <span class="re0">y</span>=<span class="st0">&quot;b&quot;</span><span class="re2">/&gt;</span></span></code></span></p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw4">var</span> x <span class="sy0">=</span> a<span class="sy0">;</span>
<span class="kw4">var</span> y <span class="sy0">=</span> b<span class="sy0">;</span></pre></div></p>

<p>If a symbol x or y is known to exist in scope as a local variable, or declared viewdata or global property, the line declaring the variable will not be generated.</p>

<h3 id="withtype">with type=""</h3>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;default</span> <span class="re0">x</span>=<span class="st0">&quot;a&quot;</span> <span class="re0">y</span>=<span class="st0">&quot;b&quot;</span> <span class="re0">type</span>=<span class="st0">&quot;t&quot;</span><span class="re2">/&gt;</span></span></code></span></p>

<p><div class="geshifilter"><pre class="geshifilter-csharp">t x <span class="sy0">=</span> a<span class="sy0">;</span>
t y <span class="sy0">=</span> b<span class="sy0">;</span></pre></div></p>

<hr />

<h2 id="else">else</h2>

<p>Forms a part of an if/elseif/else conditional structure.</p>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;else<span class="re2">&gt;</span></span></span>anyXml<span class="sc3"><span class="re1">&lt;/else<span class="re2">&gt;</span></span></span></code></span></p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw1">else</span>
<span class="br0">&#123;</span>
  <span class="co1">//anyXml-generated-code</span>
<span class="br0">&#125;</span></pre></div></p>

<p>Must follow an element that produces an if/elseif statement. Contains material that will be rendered if all preceding conditions are false.</p>

<h3 id="withif">with if=""</h3>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;else</span> <span class="re0">if</span>=<span class="st0">&quot;x&quot;</span><span class="re2">&gt;</span></span>anyXml<span class="sc3"><span class="re1">&lt;/else<span class="re2">&gt;</span></span></span></code></span></p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw1">else</span> <span class="kw1">if</span><span class="br0">&#40;</span>x<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
  <span class="co1">//anyXml-generated-code</span>
<span class="br0">&#125;</span></pre></div></p>

<p>Must follow an element that produces an if/elseif statement. Contains material that will be rendered if all preceding conditions are false, and the expression <code>x</code> evaluates to true.</p>

<h3 id="emptyelement">empty element</h3>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;test</span> <span class="re0">if</span>=<span class="st0">&quot;x&quot;</span><span class="re2">&gt;</span></span>anyXml-1<span class="sc3"><span class="re1">&lt;else</span> <span class="re0">if</span>=<span class="st0">&quot;y&quot;</span><span class="re2">/&gt;</span></span>anyXml-2<span class="sc3"><span class="re1">&lt;else</span><span class="re2">/&gt;</span></span>anyXml-3<span class="sc3"><span class="re1">&lt;/test<span class="re2">&gt;</span></span></span></code></span>
<div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw1">if</span><span class="br0">&#40;</span>x<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
  <span class="co1">//anyXml-1-generated-code</span>
<span class="br0">&#125;</span>
<span class="kw1">else</span> <span class="kw1">if</span><span class="br0">&#40;</span>y<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
  <span class="co1">//anyXml-2-generated-code</span>
<span class="br0">&#125;</span>
<span class="kw1">else</span> 
<span class="br0">&#123;</span>
  <span class="co1">//anyXml-3-generated-code</span>
<span class="br0">&#125;</span></pre></div></p>

<p>Must be contained within an <code>&lt;if&gt;</code> or <code>&lt;test&gt;</code> element. The material following an empty <code>&lt;else/&gt;</code> element is treated as if it was contained within that element. If there are multiple <code>&lt;else/&gt;</code> elements all but the last one must have an <code>if=""</code> attribute.</p>

<hr />

<h2 id="elseif">elseif</h2>

<p>Forms a part of an if/elseif/else conditional structure.</p>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;elseif</span> <span class="re0">condition</span>=<span class="st0">&quot;x&quot;</span><span class="re2">&gt;</span></span>anyXml<span class="sc3"><span class="re1">&lt;/else<span class="re2">&gt;</span></span></span></code></span></p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw1">else</span> <span class="kw1">if</span><span class="br0">&#40;</span>x<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
  <span class="co1">//anyXml-generated-code</span>
<span class="br0">&#125;</span></pre></div></p>

<p>Must follow an element that produces an if/elseif statement. Contains material that will be rendered if all preceding conditions are false, and the expression <code>x</code> evaluates to true.</p>

<hr />

<h2 id="for">for</h2>

<p>Iterates over a collection</p>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;for</span> <span class="re0">each</span>=<span class="st0">&quot;var x in y&quot;</span><span class="re2">&gt;</span></span>anyXml<span class="sc3"><span class="re1">&lt;/for<span class="re2">&gt;</span></span></span></code></span></p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw1">foreach</span><span class="br0">&#40;</span><span class="kw4">var</span> x <span class="kw1">in</span> y<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
  <span class="co1">//anyXml-generated-code</span>
<span class="br0">&#125;</span></pre></div></p>

<p>If the generated code appears to reference symbols named xIndex, xCount, xIsFirst, or xIsLast the minimum number of local variables needed will also be generated using a pattern similar to the following.</p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="br0">&#123;</span>
  <span class="kw4">int</span> xCount <span class="sy0">=</span> util_count_of<span class="br0">&#40;</span>y<span class="br0">&#41;</span><span class="sy0">;</span>
  <span class="kw4">int</span> xIndex <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>
  <span class="kw4">bool</span> xIsFirst <span class="sy0">=</span> true<span class="sy0">;</span>
  <span class="kw1">foreach</span><span class="br0">&#40;</span><span class="kw4">var</span> x <span class="kw1">in</span> y<span class="br0">&#41;</span>
  <span class="br0">&#123;</span>
    <span class="kw4">bool</span> xIsLast <span class="sy0">=</span> <span class="br0">&#40;</span>xIndex <span class="sy0">==</span> xCount <span class="sy0">-</span> <span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#123;</span>
      <span class="co1">//anyXml-generated-code</span>
    <span class="br0">&#125;</span>
    xIsFirst <span class="sy0">=</span> false<span class="sy0">;</span>
    xIndex<span class="sy0">++;</span>
  <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></p>

<h3 id="withassignments">with *="" assignments</h3>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;for</span> <span class="re0">each</span>=<span class="st0">&quot;var x in y&quot;</span> <span class="re0">a</span>=<span class="st0">&quot;b&quot;</span> <span class="re0">c</span>=<span class="st0">&quot;d&quot;</span><span class="re2">&gt;</span></span>anyXml<span class="sc3"><span class="re1">&lt;/for<span class="re2">&gt;</span></span></span></code></span></p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw1">foreach</span><span class="br0">&#40;</span><span class="kw4">var</span> x <span class="kw1">in</span> y<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
  a<span class="sy0">=</span>b<span class="sy0">;</span>
  c<span class="sy0">=</span>d<span class="sy0">;</span>
  <span class="co1">//anyXml-generated-code</span>
<span class="br0">&#125;</span></pre></div></p>

<hr />

<h2 id="global">global</h2>

<p>Declares a property that's available to all templates while rendering.</p>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;global</span> <span class="re0">x</span>=<span class="st0">&quot;a&quot;</span> <span class="re0">y</span>=<span class="st0">&quot;b&quot;</span> <span class="re0">type</span>=<span class="st0">&quot;t&quot;</span><span class="re2">/&gt;</span></span></code></span></p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw4">object</span> _x <span class="sy0">=</span> a<span class="sy0">;</span>
<span class="kw1">public</span> <span class="kw4">object</span> x <span class="br0">&#123;</span>get <span class="br0">&#123;</span><span class="kw1">return</span> _x<span class="sy0">;</span><span class="br0">&#125;</span> set <span class="br0">&#123;</span>_x <span class="sy0">=</span> value<span class="sy0">;</span><span class="br0">&#125;</span><span class="br0">&#125;</span>
&nbsp;
<span class="kw4">object</span> _y <span class="sy0">=</span> b<span class="sy0">;</span>
<span class="kw1">public</span> <span class="kw4">object</span> y <span class="br0">&#123;</span>get <span class="br0">&#123;</span><span class="kw1">return</span> _y<span class="sy0">;</span><span class="br0">&#125;</span> set <span class="br0">&#123;</span>_y <span class="sy0">=</span> value<span class="sy0">;</span><span class="br0">&#125;</span><span class="br0">&#125;</span></pre></div></p>

<p>Although object seems like an inconvenient type, it works quite well when used in simple value assignments like <code>&lt;set x="42"/&gt;</code> and expression output like <code>${x}</code>.</p>

<h3 id="withtype-1">with type=""</h3>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;global</span> <span class="re0">x</span>=<span class="st0">&quot;a&quot;</span> <span class="re0">y</span>=<span class="st0">&quot;b&quot;</span> <span class="re0">type</span>=<span class="st0">&quot;t&quot;</span><span class="re2">/&gt;</span></span></code></span></p>

<p><div class="geshifilter"><pre class="geshifilter-csharp">t _x <span class="sy0">=</span> a<span class="sy0">;</span>
<span class="kw1">public</span> t x <span class="br0">&#123;</span>get <span class="br0">&#123;</span><span class="kw1">return</span> _x<span class="sy0">;</span><span class="br0">&#125;</span> set <span class="br0">&#123;</span>_x <span class="sy0">=</span> value<span class="sy0">;</span><span class="br0">&#125;</span><span class="br0">&#125;</span>
&nbsp;
t _y <span class="sy0">=</span> b<span class="sy0">;</span>
<span class="kw1">public</span> t y <span class="br0">&#123;</span>get <span class="br0">&#123;</span><span class="kw1">return</span> _y<span class="sy0">;</span><span class="br0">&#125;</span> set <span class="br0">&#123;</span>_y <span class="sy0">=</span> value<span class="sy0">;</span><span class="br0">&#125;</span><span class="br0">&#125;</span></pre></div></p>

<hr />

<h2 id="if">if</h2>

<p>Forms a part of an if/elseif/else conditional structure.</p>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;if</span> <span class="re0">condition</span>=<span class="st0">&quot;x&quot;</span><span class="re2">&gt;</span></span>anyXml<span class="sc3"><span class="re1">&lt;/if<span class="re2">&gt;</span></span></span></code></span></p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw1">if</span><span class="br0">&#40;</span>x<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
  <span class="co1">//anyXml-generated-code</span>
<span class="br0">&#125;</span></pre></div></p>

<p>Material in an <code>if</code> element will only render if the condition evaluates to true.</p>

<p>Alias: <code>&lt;test if=""&gt;</code></p>

<hr />

<h2 id="include">include</h2>

<p>TODO: forgot to write up this one</p>

<hr />

<h2 id="macro">macro</h2>

<p>Declares a member helper function available to all templates while rendering.</p>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;macro</span> <span class="re0">name</span>=<span class="st0">&quot;anyName&quot;</span> <span class="re0">x</span>=<span class="st0">&quot;t1&quot;</span> <span class="re0">y</span>=<span class="st0">&quot;t2&quot;</span><span class="re2">&gt;</span></span>anyXml<span class="sc3"><span class="re1">&lt;/macro<span class="re2">&gt;</span></span></span></code></span></p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw1">public</span> <span class="kw4">string</span> anyName<span class="br0">&#40;</span>t1 x, t2 y<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
  <span class="co1">//anyXml-generated-code</span>
<span class="br0">&#125;</span></pre></div></p>

<p>Macros may be used invoked as part of an output expression <code>${anyName(a,b)}</code> or anyplace else code appears like <code>&lt;set z="anyName(a,b)"/&gt;</code> or <code># z=anyName(a,b);</code></p>

<hr />

<h2 id="render">render</h2>

<p>Within a partial file, renders the material wrapped by the reference to that partial file.</p>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml">anyXml2<span class="sc3"><span class="re1">&lt;render</span><span class="re2">/&gt;</span></span>anyXml4</code></span></p>

<p>Given: <span class="geshifilter"><code class="geshifilter-xml">anyXml1<span class="sc3"><span class="re1">&lt;partialFileName<span class="re2">&gt;</span></span></span>anyXml3<span class="sc3"><span class="re1">&lt;/partialFileName<span class="re2">&gt;</span></span></span>anyXml5</code></span></p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="co1">//anyXml1-generated-code</span>
<span class="br0">&#123;</span>
  <span class="co1">//anyXml2-generated-code</span>
  <span class="br0">&#123;</span>
    <span class="co1">//anyXml3-generated-code</span>
  <span class="br0">&#125;</span>
  <span class="co1">//anyXml4-generated-code</span>
<span class="br0">&#125;</span>
<span class="co1">//anyXml5-generated-code</span></pre></div></p>

<p>When <code>&lt;render/&gt;</code> appears in a partial template it generates code for the contents of the element which referenced the partial. This can be used to have a partial file which "wraps" any sort of contained material in the parent template. This enabled partials to be used as content wrappers to produce rounded corners, ajax effects, around arbirtary content.</p>

<h3 id="withsection">with section=""</h3>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml">anyXml2<span class="sc3"><span class="re1">&lt;render</span> <span class="re0">section</span>=<span class="st0">&quot;anyName&quot;</span><span class="re2">/&gt;</span></span>anyXml4</code></span></p>

<p>Given: <span class="geshifilter"><code class="geshifilter-xml">anyXml1<span class="sc3"><span class="re1">&lt;partialFileName<span class="re2">&gt;</span></span></span><span class="sc3"><span class="re1">&lt;section</span> <span class="re0">name</span>=<span class="st0">&quot;anyName&quot;</span><span class="re2">&gt;</span></span>anyXml3<span class="sc3"><span class="re1">&lt;/section<span class="re2">&gt;</span></span></span><span class="sc3"><span class="re1">&lt;/partialFileName<span class="re2">&gt;</span></span></span>anyXml5</code></span></p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="co1">//anyXml1-generated-code</span>
<span class="br0">&#123;</span>
  <span class="co1">//anyXml2-generated-code</span>
  <span class="br0">&#123;</span>
    <span class="co1">//anyXml3-generated-code</span>
  <span class="br0">&#125;</span>
  <span class="co1">//anyXml4-generated-code</span>
<span class="br0">&#125;</span>
<span class="co1">//anyXml5-generated-code</span></pre></div></p>

<p>When <code>&lt;render section=""/&gt;</code> appears in a partial template it renders the contents of the <code>&lt;section name=""&gt;</code> contained in the referencing <code>&lt;render partial=""&gt;</code> template. This enables partials to render several distinct micro-templates, for example a repeater partial could have top/bottom/even/odd named sections.</p>

<p>See also: <code>&lt;section/&gt;</code></p>

<h3 id="withassignments-1">with *="" assignments</h3>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml">anyXml2<span class="sc3"><span class="re1">&lt;render</span> <span class="re0">x</span>=<span class="st0">&quot;a&quot;</span> <span class="re0">y</span>=<span class="st0">&quot;b&quot;</span><span class="re2">/&gt;</span></span>anyXml4</code></span></p>

<p>Given: <span class="geshifilter"><code class="geshifilter-xml">anyXml1<span class="sc3"><span class="re1">&lt;partialFileName<span class="re2">&gt;</span></span></span>anyXml3<span class="sc3"><span class="re1">&lt;/partialFileName<span class="re2">&gt;</span></span></span>anyXml5</code></span></p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="co1">//anyXml1-generated-code</span>
<span class="br0">&#123;</span>
  <span class="co1">//anyXml2-generated-code</span>
  <span class="br0">&#123;</span>
    <span class="kw4">var</span> x <span class="sy0">=</span> a<span class="sy0">;</span>
    <span class="kw4">var</span> y <span class="sy0">=</span> b<span class="sy0">;</span>
    <span class="co1">//anyXml3-generated-code</span>
  <span class="br0">&#125;</span>
  <span class="co1">//anyXml4-generated-code</span>
<span class="br0">&#125;</span>
<span class="co1">//anyXml5-generated-code</span></pre></div></p>

<p>Partial files may declare local variables when rendering passed in content. They are available to the scope of the wrapped content or named section in the outer template file.</p>

<h3 id="withfallbackcontent">with fallback content</h3>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml">anyXml2<span class="sc3"><span class="re1">&lt;render</span> <span class="re0">section</span>=<span class="st0">&quot;anyName&quot;</span> <span class="re0">x</span>=<span class="st0">&quot;a&quot;</span> <span class="re0">y</span>=<span class="st0">&quot;b&quot;</span><span class="re2">&gt;</span></span>anyXml-fallback<span class="sc3"><span class="re1">&lt;/render<span class="re2">&gt;</span></span></span>anyXml4</code></span></p>

<p>Given: <span class="geshifilter"><code class="geshifilter-xml">anyXml1<span class="sc3"><span class="re1">&lt;partialFileName</span><span class="re2">/&gt;</span></span>anyXml5</code></span></p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="co1">//anyXml1-generated-code</span>
<span class="br0">&#123;</span>
  <span class="co1">//anyXml2-generated-code</span>
  <span class="br0">&#123;</span>
    <span class="kw4">var</span> x <span class="sy0">=</span> a<span class="sy0">;</span>
    <span class="kw4">var</span> y <span class="sy0">=</span> b<span class="sy0">;</span>
    <span class="co1">//anyXml-fallback-generated-code</span>
  <span class="br0">&#125;</span>
  <span class="co1">//anyXml4-generated-code</span>
<span class="br0">&#125;</span>
<span class="co1">//anyXml5-generated-code</span></pre></div></p>

<p>When the reference to a partial file is empty, or the named section does not exist, the contents of the <code>&lt;render&gt;</code> element in the partial file will generate the rendering code by default.</p>

<p>Given: <span class="geshifilter"><code class="geshifilter-xml">anyXml1<span class="sc3"><span class="re1">&lt;partialFileName<span class="re2">&gt;</span></span></span>anyXml3<span class="sc3"><span class="re1">&lt;/partialFileName<span class="re2">&gt;</span></span></span>anyXml5</code></span></p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="co1">//anyXml1-generated-code</span>
<span class="br0">&#123;</span>
  <span class="co1">//anyXml2-generated-code</span>
  <span class="br0">&#123;</span>
    <span class="kw4">var</span> x <span class="sy0">=</span> a<span class="sy0">;</span>
    <span class="kw4">var</span> y <span class="sy0">=</span> b<span class="sy0">;</span>
    <span class="co1">//anyXml3-generated-code</span>
  <span class="br0">&#125;</span>
  <span class="co1">//anyXml4-generated-code</span>
<span class="br0">&#125;</span>
<span class="co1">//anyXml5-generated-code</span></pre></div></p>

<p>When the reference to a partial file has contents, the contents of the <code>&lt;render&gt;</code> element in the partial file is unused.</p>

<hr />

<h2 id="renderpartial">render partial=""</h2>

<p>Includes the contents of a partial file for rendering at the point where it appears.</p>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;render</span> <span class="re0">partial</span>=<span class="st0">&quot;_partialFileName&quot;</span><span class="re2">/&gt;</span></span></code></span></p>

<p>Alias: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;partialFileName</span><span class="re2">/&gt;</span></span></code></span></p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="br0">&#123;</span>
  <span class="co1">//_partialFileName.spark-generated-code</span>
<span class="br0">&#125;</span></pre></div></p>

<p>Partial files may have any name, but usually start with _ by convention. The name without the underscore may be used as a short version of the <code>&lt;render/&gt;</code> element.</p>

<h3 id="withassignments-2">with *="" assignments</h3>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;render</span> <span class="re0">partial</span>=<span class="st0">&quot;_partialFileName&quot;</span> <span class="re0">x</span>=<span class="st0">&quot;a&quot;</span> <span class="re0">y</span>=<span class="st0">&quot;b&quot;</span><span class="re2">/&gt;</span></span></code></span></p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="br0">&#123;</span>
  <span class="kw4">var</span> x <span class="sy0">=</span> a<span class="sy0">;</span>
  <span class="kw4">var</span> y <span class="sy0">=</span> b<span class="sy0">;</span>
  <span class="co1">//_partialFileName.spark-generated-code</span>
<span class="br0">&#125;</span></pre></div></p>

<p>A partial file reference may declare local variables. They are available to the scope of the wrapped content or named section.</p>

<hr />

<h2 id="section">section</h2>

<p>Declares a section of material passed in to a partial file reference.</p>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml">anyXml1<span class="sc3"><span class="re1">&lt;partialFileName<span class="re2">&gt;</span></span></span><span class="sc3"><span class="re1">&lt;section</span> <span class="re0">name</span>=<span class="st0">&quot;anyName&quot;</span><span class="re2">&gt;</span></span>anyXml3<span class="sc3"><span class="re1">&lt;/section<span class="re2">&gt;</span></span></span><span class="sc3"><span class="re1">&lt;/partialFileName<span class="re2">&gt;</span></span></span>anyXml5</code></span></p>

<p>Given: <span class="geshifilter"><code class="geshifilter-xml">anyXml2<span class="sc3"><span class="re1">&lt;render</span> <span class="re0">section</span>=<span class="st0">&quot;anyName&quot;</span><span class="re2">/&gt;</span></span>anyXml4</code></span></p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="co1">//anyXml1-generated-code</span>
<span class="br0">&#123;</span>
  <span class="co1">//anyXml2-generated-code</span>
  <span class="br0">&#123;</span>
    <span class="co1">//anyXml3-generated-code</span>
  <span class="br0">&#125;</span>
  <span class="co1">//anyXml4-generated-code</span>
<span class="br0">&#125;</span>
<span class="co1">//anyXml5-generated-code</span></pre></div></p>

<p>When <code>&lt;render section=""/&gt;</code> appears in a partial template it renders the contents of the <code>&lt;section name=""&gt;</code> contained in the referencing <code>&lt;render partial=""&gt;</code> template. This enables partials to render several distinct micro-templates, for example a repeater partial could have top/bottom/even/odd named sections.</p>

<h3 id="withassignments-3">with *="" assignments</h3>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml">anyXml1<span class="sc3"><span class="re1">&lt;partialFileName<span class="re2">&gt;</span></span></span><span class="sc3"><span class="re1">&lt;section</span> <span class="re0">name</span>=<span class="st0">&quot;anyName&quot;</span> <span class="re0">x</span>=<span class="st0">&quot;a&quot;</span> <span class="re0">y</span>=<span class="st0">&quot;b&quot;</span><span class="re2">&gt;</span></span>anyXml3<span class="sc3"><span class="re1">&lt;/section<span class="re2">&gt;</span></span></span><span class="sc3"><span class="re1">&lt;/partialFileName<span class="re2">&gt;</span></span></span>anyXml5</code></span></p>

<p>Given: <span class="geshifilter"><code class="geshifilter-xml">anyXml2<span class="sc3"><span class="re1">&lt;render</span> <span class="re0">section</span>=<span class="st0">&quot;anyName&quot;</span><span class="re2">/&gt;</span></span>anyXml4</code></span></p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="co1">//anyXml1-generated-code</span>
<span class="br0">&#123;</span>
  <span class="co1">//anyXml2-generated-code</span>
  <span class="br0">&#123;</span>
    <span class="kw4">var</span> x <span class="sy0">=</span> a<span class="sy0">;</span>
    <span class="kw4">var</span> y <span class="sy0">=</span> b<span class="sy0">;</span>
    <span class="co1">//anyXml3-generated-code</span>
  <span class="br0">&#125;</span>
  <span class="co1">//anyXml4-generated-code</span>
<span class="br0">&#125;</span>
<span class="co1">//anyXml5-generated-code</span></pre></div></p>

<hr />

<h2 id="set">set</h2>

<p>Assigns an expression to a variable.</p>

<p>Usage: <set x="a" y="b"/></p>

<p><div class="geshifilter"><pre class="geshifilter-csharp">x <span class="sy0">=</span> a<span class="sy0">;</span>
y <span class="sy0">=</span> b<span class="sy0">;</span></pre></div></p>

<p>This is arguably the least interesting element in the entire Spark library. But if it wasn't there you'd probably have to escape assignments into code fragments like <code>#x = a;</code>. So there you go.</p>

<hr />

<h2 id="test">test</h2>

<p>Forms a part of an if/elseif/else conditional structure.</p>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;test</span> <span class="re0">if</span>=<span class="st0">&quot;x&quot;</span><span class="re2">&gt;</span></span>anyXml<span class="sc3"><span class="re1">&lt;/test<span class="re2">&gt;</span></span></span></code></span></p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw1">if</span><span class="br0">&#40;</span>x<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
  <span class="co1">//anyXml-generated-code</span>
<span class="br0">&#125;</span></pre></div></p>

<p>Material in a <code>test</code> element will only render if the condition evaluates to true.</p>

<p>Alias: <code>&lt;if condition=""&gt;</code></p>

<hr />

<h2 id="useassembly">use assembly=""</h2>

<p>Ensures a partially or fully qualified assembly name is include when the Spark assembly is compiled.</p>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;use</span> <span class="re0">assembly</span>=<span class="st0">&quot;system.something.something&quot;</span><span class="re2">/&gt;</span></span></code></span></p>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;use</span> <span class="re0">assembly</span>=<span class="st0">&quot;system.something.something, etc=20394824, etc=239483432&quot;</span><span class="re2">/&gt;</span></span></code></span></p>

<hr />

<h2 id="usecontent">use content=""</h2>

<p>Renders whatever has been captured in a named content spool.</p>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;use</span> <span class="re0">content</span>=<span class="st0">&quot;x&quot;</span><span class="re2">/&gt;</span></span></code></span></p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw1">if</span> <span class="br0">&#40;</span>Contents.<span class="me1">ContainsKey</span><span class="br0">&#40;</span><span class="st0">&quot;x&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
  Output.<span class="me1">Write</span><span class="br0">&#40;</span>Contents<span class="br0">&#91;</span><span class="st0">&quot;x&quot;</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></div></p>

<p>The use of content spooling is actually very efficient. It uses pooled pages of string references to replay the original output, which doesn't increase memory pressure and avoids string copying and concatination costs.</p>

<p>There is a built-in content spool named "view".</p>

<h3 id="withfallbackcontent-1">with fallback content</h3>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;use</span> <span class="re0">content</span>=<span class="st0">&quot;x&quot;</span><span class="re2">&gt;</span></span>anyXml-fallback<span class="sc3"><span class="re1">&lt;/use<span class="re2">&gt;</span></span></span></code></span></p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw1">if</span> <span class="br0">&#40;</span>Contents.<span class="me1">ContainsKey</span><span class="br0">&#40;</span><span class="st0">&quot;x&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
  Output.<span class="me1">Write</span><span class="br0">&#40;</span>Contents<span class="br0">&#91;</span><span class="st0">&quot;x&quot;</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
<span class="kw1">else</span>
<span class="br0">&#123;</span>
  <span class="co1">// anyXml-fallback-generated-code</span>
<span class="br0">&#125;</span></pre></div></p>

<p>If the named content section has never been written into the fallback output is generated. This can be used for default title contents, for example <code>&lt;title&gt;&lt;use content="title"&gt;My Default Title&lt;/use&gt;&lt;/content&gt;</code>, or for wrapping any html in the layout you may want to entirely replace in some views.</p>

<hr />

<h2 id="usefile">use file=""</h2>

<p>An alias for <code>&lt;render partial=""/&gt;</code>.</p>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;use</span> <span class="re0">file</span>=<span class="st0">&quot;_partialFileName&quot;</span><span class="re2">/&gt;</span></span></code></span></p>

<p>All behavior is identical to render partial.</p>

<hr />

<h2 id="useimport">use import=""</h2>

<p>Includes all of the elements which have a global effect declared in a template.</p>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;use</span> <span class="re0">import</span>=<span class="st0">&quot;fileName&quot;</span><span class="re2">/&gt;</span></span></code></span></p>

<p>This can be used to organize elements like <code>&lt;viewdata/&gt;</code>, <code>&lt;global/&gt;</code>, <code>&lt;macro/&gt;</code>, <code>&lt;use import=""/&gt;</code>, <code>&lt;use assembly=""/&gt;</code>, <code>&lt;use namespace=""/&gt;</code> into importable template files for greater manageability.</p>

<p>The well-known file named <code>_global.spark</code> in the current template's directory, and in the Shared directory, is automatically imported.</p>

<hr />

<h2 id="usemaster">use master=""</h2>

<p>Forces the layout around the current template file to become the named file.</p>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;use</span> <span class="re0">master</span>=<span class="st0">&quot;fileName&quot;</span><span class="re2">/&gt;</span></span></code></span></p>

<p>This will override the master which would normally have been used. Multi-level rendering can be accomplished by chaining templates with use master="" elements.</p>

<p>This element has no effect when it's in a partial file or import file.</p>

<hr />

<h2 id="usenamespace">use namespace=""</h2>

<p>Uses a dotnet namespace in the generated code.</p>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;use</span> <span class="re0">namespace</span>=<span class="st0">&quot;any.name.space&quot;</span><span class="re2">/&gt;</span></span></code></span></p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw1">using</span> <span class="co3">any.name.space</span><span class="sy0">;</span></pre></div></p>

<p>Uses a namespace. Frequently placed in an import file like _global.spark.</p>

<hr />

<h2 id="var">var</h2>

<p>Declares a local variables and it's initialization expression.</p>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;var</span> <span class="re0">x</span>=<span class="st0">&quot;a&quot;</span> <span class="re0">y</span>=<span class="st0">&quot;b&quot;</span><span class="re2">/&gt;</span></span></code></span></p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw4">var</span> x <span class="sy0">=</span> a<span class="sy0">;</span>
<span class="kw4">var</span> y <span class="sy0">=</span> b<span class="sy0">;</span></pre></div></p>

<h3 id="withtype-2">with type=""</h3>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;var</span> <span class="re0">x</span>=<span class="st0">&quot;a&quot;</span> <span class="re0">y</span>=<span class="st0">&quot;b&quot;</span> <span class="re0">type</span>=<span class="st0">&quot;t&quot;</span><span class="re2">/&gt;</span></span></code></span></p>

<p><div class="geshifilter"><pre class="geshifilter-csharp">t x <span class="sy0">=</span> a<span class="sy0">;</span>
t y <span class="sy0">=</span> b<span class="sy0">;</span></pre></div></p>

<hr />

<h2 id="viewdata">viewdata</h2>

<p>Declares an accessor property for a piece of view data.</p>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;viewdata</span> <span class="re0">x</span>=<span class="st0">&quot;t1&quot;</span> <span class="re0">y</span>=<span class="st0">&quot;t2&quot;</span> <span class="re2">/&gt;</span></span></code></span></p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw1">public</span> t1 x <span class="br0">&#123;</span> get <span class="br0">&#123;</span> <span class="kw1">return</span> <span class="br0">&#40;</span>t1<span class="br0">&#41;</span>ViewData.<span class="me1">Eval</span><span class="br0">&#40;</span><span class="st0">&quot;x&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="br0">&#125;</span> <span class="br0">&#125;</span>
<span class="kw1">public</span> t2 y <span class="br0">&#123;</span> get <span class="br0">&#123;</span> <span class="kw1">return</span> <span class="br0">&#40;</span>t2<span class="br0">&#41;</span>ViewData.<span class="me1">Eval</span><span class="br0">&#40;</span><span class="st0">&quot;y&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="br0">&#125;</span> <span class="br0">&#125;</span></pre></div></p>

<h3 id="withdefault">with default=""</h3>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;viewdata</span> <span class="re0">x</span>=<span class="st0">&quot;t1&quot;</span> <span class="re0">y</span>=<span class="st0">&quot;t2&quot;</span> <span class="re0">default</span>=<span class="st0">&quot;d&quot;</span><span class="re2">/&gt;</span></span></code></span></p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw1">public</span> t1 x <span class="br0">&#123;</span> get <span class="br0">&#123;</span> <span class="kw1">return</span> <span class="br0">&#40;</span>t1<span class="br0">&#41;</span><span class="br0">&#40;</span>ViewData.<span class="me1">Eval</span><span class="br0">&#40;</span><span class="st0">&quot;x&quot;</span><span class="br0">&#41;</span> <span class="sy0">??</span> d<span class="br0">&#41;</span><span class="sy0">;</span> <span class="br0">&#125;</span> <span class="br0">&#125;</span>
<span class="kw1">public</span> t2 y <span class="br0">&#123;</span> get <span class="br0">&#123;</span> <span class="kw1">return</span> <span class="br0">&#40;</span>t2<span class="br0">&#41;</span><span class="br0">&#40;</span>ViewData.<span class="me1">Eval</span><span class="br0">&#40;</span><span class="st0">&quot;y&quot;</span><span class="br0">&#41;</span> <span class="sy0">??</span> d<span class="br0">&#41;</span><span class="sy0">;</span> <span class="br0">&#125;</span> <span class="br0">&#125;</span></pre></div></p>

<p>Adds a fallback value for the property in cases where the actual view data is missing or null.</p>

<h3 id="withpropertyname">with property name</h3>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;viewdata</span> <span class="re0">x</span>=<span class="st0">&quot;t1 anyName1&quot;</span> <span class="re0">y</span>=<span class="st0">&quot;t2 anyName2&quot;</span> <span class="re2">/&gt;</span></span></code></span></p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw1">public</span> t1 anyName1 <span class="br0">&#123;</span> get <span class="br0">&#123;</span> <span class="kw1">return</span> <span class="br0">&#40;</span>t1<span class="br0">&#41;</span>ViewData.<span class="me1">Eval</span><span class="br0">&#40;</span><span class="st0">&quot;x&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="br0">&#125;</span> <span class="br0">&#125;</span>
<span class="kw1">public</span> t2 anyName2 <span class="br0">&#123;</span> get <span class="br0">&#123;</span> <span class="kw1">return</span> <span class="br0">&#40;</span>t2<span class="br0">&#41;</span>ViewData.<span class="me1">Eval</span><span class="br0">&#40;</span><span class="st0">&quot;y&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="br0">&#125;</span> <span class="br0">&#125;</span></pre></div></p>

<p>A name following the type will determine the name of the property which is added. This enables you to declare 
viewdata accessors which contain dashes or dots, which are not allowed in property names.</p>

<hr />

<h2 id="viewdatamodel">viewdata model=""</h2>

<p>Provides a generic parameter to strongly type the Model of the view's base class.</p>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;viewdata</span> <span class="re0">model</span>=<span class="st0">&quot;t1&quot;</span> <span class="re2">/&gt;</span></span></code></span></p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw1">public</span> <span class="kw4">class</span> generated_view_name <span class="sy0">:</span> base_view_name<span class="sy0">&lt;</span>t1<span class="sy0">&gt;</span>
<span class="br0">&#123;</span>
  <span class="kw1">public</span> t1 Model <span class="br0">&#123;</span> get <span class="br0">&#123;</span> <span class="kw1">return</span> ViewData.<span class="me1">Model</span><span class="sy0">;</span> <span class="br0">&#125;</span> <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></p>

<p>The base view class is strongly typed, and a typed property named Model is added to the generated view.</p>

<h3 id="withpropertyname-1">with property name</h3>

<p>Usage: <span class="geshifilter"><code class="geshifilter-xml"><span class="sc3"><span class="re1">&lt;viewdata</span> <span class="re0">model</span>=<span class="st0">&quot;t1 anyName&quot;</span> <span class="re2">/&gt;</span></span></code></span></p>

<p><div class="geshifilter"><pre class="geshifilter-csharp"><span class="kw1">public</span> <span class="kw4">class</span> generated_view_name <span class="sy0">:</span> base_view_name<span class="sy0">&lt;</span>t1<span class="sy0">&gt;</span>
<span class="br0">&#123;</span>
  <span class="kw1">public</span> t1 Model <span class="br0">&#123;</span> get <span class="br0">&#123;</span> <span class="kw1">return</span> ViewData.<span class="me1">Model</span><span class="sy0">;</span> <span class="br0">&#125;</span> <span class="br0">&#125;</span>
  <span class="kw1">public</span> t1 anyName <span class="br0">&#123;</span> get <span class="br0">&#123;</span> <span class="kw1">return</span> ViewData.<span class="me1">Model</span><span class="sy0">;</span> <span class="br0">&#125;</span> <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></p>

<p>A name following the type causes an additional property of that name to be added as an alias for the Model property.</p>

<hr />

<h2 id="Seealsosourcecode">See also: source code</h2>

<p>The above is based on code in the following files.</p>

<p><a href="http://github.com/loudej/spark/blob/master/src/Spark/Compiler/NodeVisitors/ChunkBuilderVisitor.cs">ChunkBuilderVisitor.cs</a></p>

<p><a href="http://github.com/loudej/spark/blob/master/src/Spark/Compiler/CSharp/ChunkVisitors/GeneratedCodeVisitor.cs">GeneratedCodeVisitor.cs</a></p>
  </div>
</div>
</div>
    
  </body>
</html>
